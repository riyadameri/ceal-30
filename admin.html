<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تكتل الطلبة الجزائريين الأحرار - ورقلة | نظام الإدارة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* جميع الأنماط السابقة تبقى كما هي */
        :root {
            --primary-green: #006633;
            --dark-green: #004d26;
            --light-green: #009944;
            --lighter-green: #e6f4ea;
            --gradient-green: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            --gold: #D4AF37;
            --light-gold: #F4E4A6;
            --dark-gold: #b8941f;
            --gradient-gold: linear-gradient(135deg, var(--gold), var(--dark-gold));
            --white: #FFFFFF;
            --light-gray: #F8F9FA;
            --medium-gray: #E9ECEF;
            --dark-gray: #212529;
            --text-color: #333333;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            --border-radius: 16px;
            --border-radius-sm: 10px;
            --header-height: 80px;
            --header-height-scrolled: 70px;
            --sidebar-width: 280px;
            --mobile-sidebar-width: 85vw;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Cairo', sans-serif;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--light-gray);
            direction: rtl;
            overflow-x: hidden;
            font-size: 1rem;
            height: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        body, .main-content, .chat-container, .chat-messages, .table-responsive {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .splash-screen {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-green);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeOut 0.5s ease 1.5s forwards;
        }

        .splash-logo {
            width: 100px;
            height: 100px;
            border-radius: 25px;
            border: 5px solid var(--gold);
            object-fit: cover;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .splash-text {
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 15px;
        }

        .splash-loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        .nav-wrapper {
            background: var(--gradient-green);
            color: var(--white);
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: var(--header-height);
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .nav-wrapper.scrolled {
            height: var(--header-height-scrolled);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 100%;
            max-width: 100%;
            margin: 0;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            max-width: 70%;
        }

        .nav-logo img {
            height: 45px;
            width: 45px;
            border-radius: 12px;
            border: 2px solid var(--gold);
            object-fit: cover;
            flex-shrink: 0;
        }

        .nav-logo-text {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .nav-logo-text h1 {
            font-size: 1rem;
            color: var(--white);
            margin-bottom: 2px;
            font-weight: 800;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-logo-text p {
            font-size: 0.7rem;
            color: var(--light-gold);
            margin-bottom: 0;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            font-size: 1.2rem;
            color: var(--white);
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            z-index: 1002;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
            padding: 6px 8px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            max-width: 200px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold);
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 700;
            color: var(--white);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.7rem;
            color: var(--light-gold);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-points {
            background: var(--gradient-gold);
            color: var(--dark-green);
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.8rem;
            white-space: nowrap;
            display: none;
        }

        .user-dropdown {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            background: var(--white);
            min-width: 100%;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 10px 0;
            display: none;
            z-index: 1001;
            animation: dropdownFade 0.3s ease;
            border: 1px solid var(--medium-gray);
            max-height: 70vh;
            overflow-y: auto;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: var(--dark-gray);
            transition: var(--transition);
            border-bottom: 1px solid var(--medium-gray);
            text-decoration: none;
        }

        .user-dropdown a:last-child {
            border-bottom: none;
        }

        .user-dropdown a:hover {
            background: var(--lighter-green);
            color: var(--primary-green);
            padding-right: 25px;
        }

        .user-dropdown i {
            width: 20px;
            text-align: center;
            color: var(--gold);
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            height: 100vh;
            position: fixed;
            top: 0;
            right: -100%;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
            padding: 80px 0 90px 0;
            overflow-y: auto;
            z-index: 999;
            transition: var(--transition);
            border-left: 1px solid var(--medium-gray);
        }

        .sidebar.active {
            right: 0;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                right: -100%;
            }
            to {
                right: 0;
            }
        }

        .sidebar-menu {
            list-style: none;
            padding: 0 10px;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 15px;
            color: var(--dark-gray);
            transition: var(--transition);
            border-radius: var(--border-radius-sm);
            border-right: 4px solid transparent;
            font-weight: 600;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: var(--lighter-green);
            color: var(--primary-green);
            border-right-color: var(--gold);
            padding-right: 20px;
        }

        .sidebar-menu i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
            color: var(--primary-green);
        }

        .sidebar-menu .badge {
            margin-right: auto;
            background: var(--gradient-gold);
            color: var(--dark-green);
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 800;
            min-width: 24px;
            text-align: center;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            animation: overlayFade 0.3s ease;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        .main-content {
            margin-right: 0;
            margin-top: var(--header-height);
            padding: 20px 15px;
            min-height: calc(100vh - var(--header-height));
            background: var(--light-gray);
            transition: var(--transition);
            overflow-y: auto;
            height: calc(100vh - var(--header-height));
            padding-bottom: 80px;
        }

        .main-content.no-bottom-nav {
            padding-bottom: 20px;
        }

        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            background: var(--white);
            border-top: 1px solid var(--medium-gray);
            padding: 10px 0 calc(10px + var(--safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .bottom-nav.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            list-style: none;
            padding: 0 5px;
        }

        .bottom-nav-item {
            text-align: center;
            flex: 1;
            max-width: 20%;
        }

        .bottom-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--dark-gray);
            padding: 8px 5px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            text-decoration: none;
            position: relative;
        }

        .bottom-nav-link.active {
            color: var(--primary-green);
            background: var(--lighter-green);
            transform: translateY(-5px);
        }

        .bottom-nav-link i {
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .bottom-nav-link.active i {
            color: var(--gold);
            transform: scale(1.1);
        }

        .bottom-nav-link span {
            font-size: 0.7rem;
            font-weight: 700;
            transition: var(--transition);
        }

        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
            
            .nav-wrapper {
                height: 70px;
                padding: 0;
            }
            
            .nav-container {
                padding: 0 10px;
            }
            
            .nav-logo img {
                height: 40px;
                width: 40px;
            }
            
            .nav-logo-text h1 {
                font-size: 0.9rem;
            }
            
            .nav-logo-text p {
                font-size: 0.65rem;
            }
            
            .user-details {
                display: none;
            }
            
            .user-points {
                display: none;
            }
            
            .mobile-menu-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .sidebar {
                width: var(--mobile-sidebar-width);
                right: -100%;
            }
            
            .sidebar-menu a {
                padding: 14px 15px;
                font-size: 0.9rem;
            }
            
            .main-content {
                margin-top: 70px;
                padding: 15px 12px;
                padding-bottom: 70px;
                height: calc(100vh - 70px);
            }
            
            .user-dropdown {
                top: 70px;
            }
            
            .bottom-nav {
                display: block;
            }
            
            input, select, textarea {
                font-size: 16px !important;
            }
            
            @media screen and (max-width: 768px) {
                input[type="text"],
                input[type="email"],
                input[type="password"],
                input[type="number"],
                select,
                textarea {
                    font-size: 16px !important;
                }
            }
        }

        @media (min-width: 769px) {
            .sidebar {
                right: 0;
            }
            
            .main-content {
                margin-right: var(--sidebar-width);
                padding-bottom: 30px;
            }
            
            .mobile-menu-btn {
                display: none;
            }
            
            .bottom-nav {
                display: none !important;
            }
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: -webkit-fill-available;
            background: var(--white);
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            z-index: 1100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
            opacity: 0;
            visibility: hidden;
        }

        .chat-container.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }

        .chat-header {
            padding: 15px;
            background: var(--gradient-green);
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 70px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: auto;
        }

        .chat-back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--white);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .chat-back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100% - 70px);
        }

        .chat-messages-wrapper {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7ec 100%);
            min-height: 0;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
            position: relative;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease forwards;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
        }

        .message-sent {
            background: linear-gradient(135deg, var(--light-green), var(--primary-green));
            color: var(--white);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message-received {
            background: var(--white);
            color: var(--dark-gray);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--medium-gray);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 4px;
            text-align: right;
            direction: ltr;
        }

        .message-status {
            font-size: 0.7rem;
            margin-top: 2px;
            text-align: right;
            opacity: 0.7;
        }

        .chat-input-container {
            background: var(--white);
            border-top: 1px solid var(--medium-gray);
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            min-height: 70px;
        }

        .chat-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--light-gray);
            border-radius: 25px;
            padding: 5px 15px;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--gold);
            background: var(--white);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 5px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            color: var(--dark-gray);
            outline: none;
            min-height: 46px;
            line-height: 1.4;
        }

        .chat-input::placeholder {
            color: var(--dark-gray);
            opacity: 0.6;
        }

        .chat-action-btn {
            background: transparent;
            border: none;
            color: var(--primary-green);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .chat-action-btn:hover {
            background: var(--lighter-green);
        }

        .chat-send-btn {
            background: var(--gradient-green);
            color: var(--white);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 102, 51, 0.3);
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 102, 51, 0.4);
        }

        .chat-send-btn:active {
            transform: scale(0.95);
        }

        .message-image {
            max-width: 250px;
            max-height: 250px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .message-image:hover {
            transform: scale(1.02);
            border-color: var(--gold);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: var(--white);
            border-radius: 18px;
            width: fit-content;
            margin-bottom: 8px;
            border: 1px solid var(--medium-gray);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-green);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-list-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--white);
        }

        .chat-search-container {
            padding: 15px;
            background: var(--white);
            border-bottom: 1px solid var(--medium-gray);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .chat-search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--medium-gray);
            border-radius: 25px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95rem;
            background: var(--light-gray);
            transition: var(--transition);
        }

        .chat-search-input:focus {
            outline: none;
            border-color: var(--gold);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
        }

        .chat-search-icon {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark-gray);
            opacity: 0.6;
        }

        .chat-list-items {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
        }

        .chat-list-item {
            padding: 12px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 8px;
            background: var(--white);
            border: 1px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-list-item:hover {
            background: var(--lighter-green);
            border-color: var(--gold);
            transform: translateX(-3px);
        }

        .chat-list-item.active {
            background: var(--lighter-green);
            border-color: var(--gold);
        }

        .chat-list-item-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold);
            flex-shrink: 0;
            background: var(--gradient-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-green);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .chat-list-item-info {
            flex: 1;
            min-width: 0;
        }

        .chat-list-item-name {
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 4px;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item-last-message {
            color: var(--dark-gray);
            opacity: 0.7;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .chat-list-item-time {
            font-size: 0.75rem;
            color: var(--dark-gray);
            opacity: 0.6;
            white-space: nowrap;
        }

        .chat-list-item-unread {
            background: var(--gradient-green);
            color: var(--white);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 20px;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100%;
                width: 100%;
            }
            
            .chat-header {
                padding: 12px 15px;
                min-height: 60px;
            }
            
            .chat-main-content {
                height: calc(100% - 60px);
            }
            
            .chat-input-container {
                padding: 8px 12px;
                min-height: 60px;
            }
            
            .chat-input {
                min-height: 42px;
                font-size: 16px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-image {
                max-width: 200px;
                max-height: 200px;
            }
        }

        .chat-messages-wrapper {
            -webkit-overflow-scrolling: touch;
            overflow-y: scroll;
        }

        .chat-messages-wrapper::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages-wrapper::-webkit-scrollbar-thumb {
            background: var(--primary-green);
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 102, 51, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-gold);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--hover-shadow);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
            flex-shrink: 0;
        }

        .stat-info {
            flex: 1;
            min-width: 0;
        }

        .stat-info h3 {
            margin-bottom: 5px;
            color: var(--dark-gray);
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stat-number {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary-green);
            line-height: 1;
            margin-bottom: 3px;
        }

        .stat-text {
            font-size: 0.8rem;
            color: var(--dark-gray);
            opacity: 0.8;
        }

        .table-container {
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border: 1px solid rgba(0, 102, 51, 0.1);
        }

        .table-header {
            padding: 15px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            background: var(--lighter-green);
        }

        .table-header h3 {
            margin-bottom: 0;
            color: var(--primary-green);
            font-weight: 800;
            font-size: 1.1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 300px;
        }

        th {
            background: var(--lighter-green);
            color: var(--primary-green);
            font-weight: 700;
            padding: 12px 10px;
            text-align: right;
            border-bottom: 2px solid var(--medium-gray);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--medium-gray);
            vertical-align: middle;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        tr:hover td {
            background: rgba(0, 102, 51, 0.05);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }

        .table-responsive::-webkit-scrollbar {
            height: 4px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--gradient-gold);
            color: var(--dark-green);
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 800;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
            text-decoration: none;
            min-height: 44px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: var(--gradient-green);
            transition: var(--transition);
            z-index: -1;
        }

        .btn:hover {
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.8rem;
            min-height: 36px;
        }

        .btn-primary {
            background: var(--gradient-green);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 102, 51, 0.3);
        }

        .btn-primary::before {
            background: var(--gradient-gold);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: var(--gradient-gold);
            border-color: transparent;
            color: var(--dark-green);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            animation: modalFade 0.3s ease;
        }

        @keyframes modalFade {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--white);
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes modalSlide {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            background: var(--gradient-green);
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 {
            color: var(--white);
            margin-bottom: 0;
            font-weight: 800;
            font-size: 1.2rem;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--white);
            font-size: 1.3rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-green);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius-sm);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--light-gray);
            color: var(--dark-gray);
            font-weight: 500;
            min-height: 48px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 150px);
            }
        }

        .profile-header {
            background: var(--gradient-green);
            color: var(--white);
            padding: 25px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            text-align: center;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--gold);
            position: relative;
            z-index: 1;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .profile-info {
            flex: 1;
            position: relative;
            z-index: 1;
            width: 100%;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .profile-stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            backdrop-filter: blur(5px);
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--gold);
            display: block;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--light-gold);
            margin-top: 3px;
            font-weight: 600;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--gradient-green);
            overflow-y: auto;
        }

        .auth-box {
            background: var(--white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            animation: fadeInUp 0.6s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-header {
            padding: 30px 20px;
            text-align: center;
            background: var(--gradient-green);
            color: var(--white);
        }

        .auth-header img {
            width: 100px;
            height: 100px;
            border-radius: 20px;
            border: 3px solid var(--gold);
            object-fit: cover;
            margin-bottom: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .auth-header h2 {
            color: var(--white);
            margin-bottom: 8px;
            font-weight: 800;
            font-size: 1.4rem;
        }

        .auth-header p {
            color: var(--light-gold);
            font-size: 0.9rem;
        }

        .auth-body {
            padding: 30px 20px;
        }

        .auth-form h3 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-green);
            font-weight: 800;
            font-size: 1.3rem;
        }

        .auth-footer {
            padding: 20px;
            text-align: center;
            background: var(--light-gray);
            border-top: 1px solid var(--medium-gray);
            color: var(--dark-gray);
            font-size: 0.85rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes overlayFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-right: 4px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-success {
            background: #D4EDDA;
            color: #155724;
            border-right-color: #28a745;
        }

        .alert-error {
            background: #F8D7DA;
            color: #721C24;
            border-right-color: #dc3545;
        }

        .alert-warning {
            background: #FFF3CD;
            color: #856404;
            border-right-color: #ffc107;
        }

        .alert-info {
            background: #D1ECF1;
            color: #0C5460;
            border-right-color: #17a2b8;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient-green);
            color: var(--white);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .success-message.show {
            transform: translateX(0);
        }

        .success-icon {
            font-size: 2rem;
            color: var(--gold);
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload-btn {
            width: 100%;
            padding: 15px;
            background: var(--light-gray);
            border: 2px dashed var(--medium-gray);
            border-radius: var(--border-radius-sm);
            color: var(--dark-gray);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .file-upload-btn:hover {
            background: var(--lighter-green);
            border-color: var(--gold);
        }

        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .image-preview {
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .image-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--medium-gray);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 480px) {
            html {
                font-size: 13px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-icon {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }
            
            .stat-number {
                font-size: 1.4rem;
            }
            
            .profile-header {
                padding: 20px 15px;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
            }
            
            .profile-stat {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 1.4rem;
            }
            
            .auth-box {
                max-width: 100%;
            }
            
            .message {
                max-width: 90%;
            }
            
            .bottom-nav-link span {
                font-size: 0.65rem;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-green);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-green);
        }

        ::selection {
            background: var(--gold);
            color: var(--dark-green);
        }

        ::-moz-selection {
            background: var(--gold);
            color: var(--dark-green);
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-modal.show {
            display: flex;
            animation: modalFade 0.3s ease;
        }

        .image-modal-content {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .interactive-element {
            cursor: pointer;
            transition: var(--transition);
        }

        .interactive-element:active {
            transform: scale(0.95);
        }

        @media (hover: hover) {
            .btn:hover {
                transform: translateY(-3px);
            }
            
            .chat-item:hover {
                transform: translateX(-3px);
            }
        }

        .mobile-only {
            display: none;
        }

        .desktop-only {
            display: block;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }
            
            .desktop-only {
                display: none;
            }
            
            .nav-logo-text p {
                display: none;
            }
        }

        .will-change {
            will-change: transform, opacity;
        }

        .page-content {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .default-avatar {
            background: var(--gradient-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-green);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--medium-gray);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-green);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .profile-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
                margin: 0 auto;
            }
        }

        @media (max-height: 600px) {
            .sidebar {
                padding: 70px 0 80px 0;
            }
            
            .chat-sidebar {
                height: 150px;
            }
            
            .profile-header {
                padding: 15px;
            }
            
            .profile-avatar {
                width: 70px;
                height: 70px;
            }
        }
        
        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .loader-overlay.show {
            display: flex;
            animation: modalFade 0.3s ease;
        }
        
        .loader-content {
            background: var(--white);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            min-width: 200px;
        }
        
        .loader-content .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .loader-message {
            color: var(--dark-gray);
            font-weight: 600;
        }
    </style>

</head>
<body>
    <!-- شاشة التحميل -->
    <div class="splash-screen">
        <img src="https://scontent.falg3-2.fna.fbcdn.net/v/t39.30808-6/585009692_1286822876817480_1598676277220308871_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=YEmku632RLQQ7kNvwEFwDDM&_nc_oc=Admh22ryBBsTYka4t5aP0Rfhfc_D2S19LaMapdPa1ydDqx9_RQaeoGkWWtlB6Czm2FE&_nc_zt=23&_nc_ht=scontent.falg3-2.fna&_nc_gid=lnmw7goUav9V7e9IGhwZtw&oh=00_Afo3AtSTpUCLtO8zmJ0ia3LsQwmTJ-6FOqam4yxat65kbw&oe=696FD587" 
             alt="شعار التكتل" class="splash-logo">
        <div class="splash-text">تكتل الطلبة الجزائريين الأحرار</div>
        <div class="splash-text">فرع ورقلة - نظام الإدارة</div>
        <div class="splash-loader"></div>
    </div>

    <!-- شاشة المصادقة -->
    <div id="authPage" class="auth-container" style="display: none;">
        <div class="auth-box">
            <div class="auth-header">
                <img src="https://scontent.falg3-2.fna.fbcdn.net/v/t39.30808-6/585009692_1286822876817480_1598676277220308871_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=YEmku632RLQQ7kNvwEFwDDM&_nc_oc=Admh22ryBBsTYka4t5aP0Rfhfc_D2S19LaMapdPa1ydDqx9_RQaeoGkWWtlB6Czm2FE&_nc_zt=23&_nc_ht=scontent.falg3-2.fna&_nc_gid=lnmw7goUav9V7e9IGhwZtw&oh=00_Afo3AtSTpUCLtO8zmJ0ia3LsQwmTJ-6FOqam4yxat65kbw&oe=696FD587" 
                     alt="شعار التكتل" class="auth-logo">
                <h2>تكتل الطلبة الجزائريين الأحرار</h2>
                <p>فرع ورقلة - نظام الإدارة</p>
            </div>
            
            <div class="auth-body">
                <div id="loginForm" class="auth-form">
                    <h3>تسجيل الدخول</h3>
                    <div class="form-group">
                        <label class="form-label">اسم المستخدم أو البريد الإلكتروني</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="أدخل اسم المستخدم أو البريد">
                    </div>
                    <div class="form-group">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="أدخل كلمة المرور">
                    </div>
                    <button id="loginBtn" class="btn btn-block" style="margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                    </button>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" id="showRegister" style="color: var(--primary-green); font-weight: 700;">
                            ليس لديك حساب؟ سجل الآن
                        </a>
                    </div>
                </div>
                
                <div id="registerForm" class="auth-form" style="display: none;">
                    <h3>إنشاء حساب جديد</h3>
                    <div class="form-group">
                        <label class="form-label">اسم المستخدم</label>
                        <input type="text" id="registerUsername" class="form-control" placeholder="أدخل اسم المستخدم">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الاسم الكامل</label>
                        <input type="text" id="registerFullName" class="form-control" placeholder="أدخل اسمك الكامل">
                    </div>
                    <div class="form-group">
                        <label class="form-label">البريد الإلكتروني</label>
                        <input type="email" id="registerEmail" class="form-control" placeholder="أدخل بريدك الإلكتروني">
                    </div>
                    <div class="form-group">
                        <label class="form-label">رقم القيد الجامعي</label>
                        <input type="text" id="registerUniversityId" class="form-control" placeholder="أدخل رقم القيد الجامعي">
                    </div>
                    <div class="form-group">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" id="registerPassword" class="form-control" placeholder="أدخل كلمة المرور">
                    </div>
                    <div class="form-group">
                        <label class="form-label">تأكيد كلمة المرور</label>
                        <input type="password" id="registerConfirmPassword" class="form-control" placeholder="أكد كلمة المرور">
                    </div>
                    <button id="registerBtn" class="btn btn-block" style="margin-top: 20px;">
                        <i class="fas fa-user-plus"></i> إنشاء الحساب
                    </button>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" id="showLogin" style="color: var(--primary-green); font-weight: 700;">
                            لديك حساب بالفعل؟ سجل دخول
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="auth-footer">
                <p>© 2024 تكتل الطلبة الجزائريين الأحرار - فرع ورقلة</p>
                <p style="margin-top: 10px;">تم التطوير بواسطة: <strong>Redox Ameri Riyad Youcef</strong></p>
            </div>
        </div>
    </div>

    <!-- الشريط العلوي -->
    <div id="navWrapper" class="nav-wrapper" style="display: none;">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="https://scontent.falg3-2.fna.fbcdn.net/v/t39.30808-6/585009692_1286822876817480_1598676277220308871_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=YEmku632RLQQ7kNvwEFwDDM&_nc_oc=Admh22ryBBsTYka4t5aP0Rfhfc_D2S19LaMapdPa1ydDqx9_RQaeoGkWWtlB6Czm2FE&_nc_zt=23&_nc_ht=scontent.falg3-2.fna&_nc_gid=lnmw7goUav9V7e9IGhwZtw&oh=00_Afo3AtSTpUCLtO8zmJ0ia3LsQwmTJ-6FOqam4yxat65kbw&oe=696FD587" 
                     alt="شعار التكتل">
                <div class="nav-logo-text">
                    <h1>تكتل الطلبة الجزائريين الأحرار</h1>
                    <p>فرع ورقلة - نظام الإدارة</p>
                </div>
            </div>
            
            <div class="nav-user">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-info" id="userInfo">
                    <div id="userAvatar" class="user-avatar default-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <span id="userName" class="user-name">المستخدم</span>
                        <span id="userRole" class="user-role">عضو</span>
                    </div>
                    <div id="userPoints" class="user-points">0 نقاط</div>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" onclick="showPage('profile')"><i class="fas fa-user"></i> الملف الشخصي</a>
                        <a href="#" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a>
                        <a href="#" onclick="showPage('messages')"><i class="fas fa-comments"></i> الرسائل</a>
                        <a href="#" onclick="showPage('background')"><i class="fas fa-image"></i> خلفية الصفحة</a>
                        <a href="#" id="adminLink" style="display: none;"><i class="fas fa-cog"></i> لوحة الإدارة</a>
                        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- طبقة الشفافية للشريط الجانبي -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- الشريط الجانبي -->
    <div id="sidebar" class="sidebar">
        <ul class="sidebar-menu">
            <li><a href="#" onclick="showPage('dashboard')" class="active"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
            <li><a href="#" onclick="showPage('messages')"><i class="fas fa-comments"></i> الرسائل <span class="badge" id="unreadBadge">0</span></a></li>
            <li><a href="#" onclick="showPage('tasks')"><i class="fas fa-tasks"></i> المهام <span class="badge" id="tasksBadge">0</span></a></li>
            <li><a href="#" onclick="showPage('activities')"><i class="fas fa-calendar-alt"></i> الأنشطة <span class="badge" id="activitiesBadge">0</span></a></li>
            <li><a href="#" onclick="showPage('members')"><i class="fas fa-users"></i> الأعضاء</a></li>
            <li><a href="#" onclick="showPage('background')"><i class="fas fa-image"></i> خلفية الصفحة</a></li>
            <li><a href="#" onclick="showPage('profile')"><i class="fas fa-user"></i> الملف الشخصي</a></li>
            <li id="adminMenuItem" style="display: none;"><a href="#" onclick="showPage('admin')"><i class="fas fa-cog"></i> الإدارة</a></li>
        </ul>
        
        <!-- قسم الفريق المطور في الشريط الجانبي -->
        <div class="dev-team" style="margin: 15px; padding: 12px; background: var(--lighter-green); border-radius: var(--border-radius-sm);">
            <p style="font-size: 0.85rem; color: var(--primary-green); margin-bottom: 5px; font-weight: 700;">تم التطوير بواسطة:</p>
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;">
                <span style="background: var(--gradient-gold); color: var(--dark-green); padding: 3px 8px; border-radius: 15px; font-size: 0.75rem; font-weight: 700;">Redox</span>
                <span style="background: var(--gradient-gold); color: var(--dark-green); padding: 3px 8px; border-radius: 15px; font-size: 0.75rem; font-weight: 700;">Ameri</span>
                <span style="background: var(--gradient-gold); color: var(--dark-green); padding: 3px 8px; border-radius: 15px; font-size: 0.75rem; font-weight: 700;">Riyad</span>
                <span style="background: var(--gradient-gold); color: var(--dark-green); padding: 3px 8px; border-radius: 15px; font-size: 0.75rem; font-weight: 700;">Youcef</span>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div id="mainContent" class="main-content" style="display: none;">
        <!-- صفحة لوحة التحكم -->
        <div id="dashboardPage" class="page-content">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">لوحة التحكم</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">مرحباً بك في نظام إدارة تكتل الطلبة الجزائريين الأحرار - فرع ورقلة</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الأعضاء</h3>
                        <div class="stat-number" id="totalMembers">0</div>
                        <div class="stat-text">عضو نشط</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <h3>المهام النشطة</h3>
                        <div class="stat-number" id="activeTasks">0</div>
                        <div class="stat-text">مهمة تحت التنفيذ</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>الأنشطة القادمة</h3>
                        <div class="stat-number" id="upcomingActivities">0</div>
                        <div class="stat-text">نشاط مقبل</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-info">
                        <h3>الرسائل غير المقروءة</h3>
                        <div class="stat-number" id="unreadMessages">0</div>
                        <div class="stat-text">رسالة جديدة</div>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>آخر المهام</h3>
                    <button class="btn btn-sm" onclick="showPage('tasks')">
                        <i class="fas fa-eye"></i> عرض الكل
                    </button>
                </div>
                <div class="table-responsive">
                    <div id="recentTasksTable">
                        <p style="text-align: center; padding: 20px;">جاري تحميل المهام...</p>
                    </div>
                </div>
            </div>
            
            <div class="table-container" style="margin-top: 20px;">
                <div class="table-header">
                    <h3>الأنشطة القادمة</h3>
                    <button class="btn btn-sm" onclick="showPage('activities')">
                        <i class="fas fa-eye"></i> عرض الكل
                    </button>
                </div>
                <div class="table-responsive">
                    <div id="upcomingActivitiesTable">
                        <p style="text-align: center; padding: 20px;">جاري تحميل الأنشطة...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة الرسائل المحسنة -->
        <div id="messagesPage" class="page-content" style="display: none;">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">الرسائل</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">تواصل مع أعضاء التكتل وأرسل الصور</p>
            
            <!-- واجهة المحادثات الرئيسية -->
            <div class="chat-list-container">
                <div class="chat-search-container">
                    <div style="position: relative;">
                        <input type="text" class="chat-search-input" id="chatSearchInput" 
                               placeholder="ابحث في المحادثات أو الأعضاء...">
                        <i class="fas fa-search chat-search-icon"></i>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="showNewMessageModal()" 
                            style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> بدء محادثة جديدة
                    </button>
                </div>
                
                <div class="chat-list-items" id="chatList">
                    <!-- سيتم ملؤها بالدردشات -->
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-comments" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark-gray); font-size: 1.1rem;">لا توجد محادثات</h3>
                        <p style="color: var(--dark-gray); font-size: 0.9rem;">ابدأ محادثة جديدة للتواصل مع الأعضاء</p>
                        <button class="btn" onclick="showNewMessageModal()" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> بدء محادثة
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- واجهة المحادثة الفردية (مخفية افتراضياً) -->
            <div id="chatInterface" class="chat-container">
                <div class="chat-header">
                    <button class="chat-back-btn" onclick="closeChat()">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <div class="chat-list-item-avatar" id="currentChatAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 id="currentChatName" style="margin-bottom: 0; font-size: 1.1rem;">اسم المستخدم</h3>
                        <p id="currentChatStatus" style="margin-bottom: 0; font-size: 0.85rem; opacity: 0.8;">متصل الآن</p>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-action-btn" onclick="showChatInfo()">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-main-content">
                    <div class="chat-messages-wrapper" id="chatMessages">
                        <!-- سيتم ملؤها بالرسائل -->
                        <div style="text-align: center; padding: 30px 20px;">
                            <p style="color: var(--dark-gray); opacity: 0.7;">جاري تحميل المحادثة...</p>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <button class="chat-action-btn" onclick="attachImageToMessage()">
                            <i class="fas fa-image"></i>
                        </button>
                        
                        <div class="chat-input-wrapper">
                            <input type="text" id="messageInput" class="chat-input" 
                                   placeholder="اكتب رسالتك هنا..." autocomplete="off">
                        </div>
                        
                        <button class="chat-send-btn" onclick="sendMessage()" id="sendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة المهام -->
        <div id="tasksPage" class="page-content" style="display: none;">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">المهام</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">إدارة المهام الموكلة إليك</p>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>مهامي</h3>
                    <button class="btn btn-primary" onclick="showCreateTaskModal()">
                        <i class="fas fa-plus"></i> مهمة جديدة
                    </button>
                </div>
                <div class="table-responsive">
                    <div id="tasksTable">
                        <p style="text-align: center; padding: 20px; color: var(--dark-gray);">جاري تحميل المهام...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة الأنشطة -->
        <div id="activitiesPage" class="page-content" style="display: none;">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">الأنشطة</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">أنشطة التكتل والفعاليات</p>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>الأنشطة</h3>
                    <button class="btn btn-primary" onclick="showCreateActivityModal()">
                        <i class="fas fa-plus"></i> نشاط جديد
                    </button>
                </div>
                <div class="table-responsive">
                    <div id="activitiesTable">
                        <p style="text-align: center; padding: 20px; color: var(--dark-gray);">جاري تحميل الأنشطة...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة خلفية الصفحة -->
        <div id="backgroundPage" class="page-content" style="display: none;">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">خلفية الصفحة</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">قم بتخصيص خلفية صفحتك باستخدام صورة من اختيارك</p>
            
            <div class="background-settings" style="background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                <h3 style="color: var(--primary-green); margin-bottom: 15px;">إعدادات الخلفية</h3>
                <p style="margin-bottom: 20px; color: var(--dark-gray); font-size: 0.9rem;">يمكنك رفع صورة لتكون خلفية لصفحتك الشخصية. سيتم حفظ الصورة كبيانات (Base64) وليس كملف.</p>
                
                <div class="form-group">
                    <label class="form-label">اختر صورة خلفية</label>
                    <div class="file-upload">
                        <div class="file-upload-btn" id="backgroundUploadBtn">
                            <i class="fas fa-cloud-upload-alt"></i> اختر صورة أو اسحبها هنا
                        </div>
                        <input type="file" id="backgroundImage" class="form-control" accept="image/*" onchange="previewBackgroundImage(this)">
                    </div>
                    <div class="image-preview" id="backgroundImagePreview">
                        <div style="width: 100%; height: 150px; background-size: cover; background-position: center; border-radius: var(--border-radius-sm); border: 2px dashed var(--medium-gray);" id="backgroundPreview"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">نمط الخلفية</label>
                    <select id="backgroundStyle" class="form-control">
                        <option value="cover">تغطية كاملة</option>
                        <option value="contain">احتواء</option>
                        <option value="repeat">تكرار</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">شفافية الخلفية</label>
                    <input type="range" id="backgroundOpacity" class="form-control" min="0.1" max="1" step="0.1" value="0.9">
                    <span id="opacityValue" style="display: block; text-align: center; margin-top: 5px; font-weight: 700;">90%</span>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="saveBackgroundSettings()">
                    <i class="fas fa-save"></i> حفظ إعدادات الخلفية
                </button>
                
                <button class="btn btn-outline btn-block" style="margin-top: 15px;" onclick="resetBackground()">
                    <i class="fas fa-undo"></i> إعادة تعيين الخلفية
                </button>
            </div>
            
            <div class="table-container" style="margin-top: 20px;">
                <div class="table-header">
                    <h3>خلفياتي المحفوظة</h3>
                </div>
                <div id="savedBackgrounds">
                    <p style="text-align: center; padding: 20px; color: var(--dark-gray);">لا توجد خلفيات محفوظة</p>
                </div>
            </div>
        </div>
        
        <!-- صفحة الأعضاء -->
        <div id="membersPage" class="page-content" style="display: none;">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">الأعضاء</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">قائمة أعضاء التكتل</p>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>قائمة الأعضاء</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <input type="text" id="memberSearch" class="form-control" placeholder="ابحث عن عضو..." style="min-width: 150px;">
                        <button class="btn btn-primary" onclick="loadMembers()">
                            <i class="fas fa-search"></i> بحث
                        </button>
                        <button class="btn" onclick="loadMembers()">
                            <i class="fas fa-sync-alt"></i> تحديث
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <div id="membersTable">
                        <p style="text-align: center; padding: 20px; color: var(--dark-gray);">جاري تحميل الأعضاء...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة الملف الشخصي -->
        <div id="profilePage" class="page-content" style="display: none;">
            <div class="profile-header">
                <div id="profileAvatar" class="profile-avatar default-avatar">
                    <i class="fas fa-user" style="font-size: 2.5rem;"></i>
                </div>
                <div class="profile-info">
                    <h1 id="profileName" style="font-size: 1.3rem;">اسم المستخدم</h1>
                    <p id="profileEmail" style="font-size: 0.9rem;">البريد الإلكتروني</p>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <span class="stat-value" id="profilePoints">0</span>
                            <span class="stat-label">نقطة</span>
                        </div>
                        <div class="profile-stat">
                            <span class="stat-value" id="profileTasks">0</span>
                            <span class="stat-label">مهمة</span>
                        </div>
                        <div class="profile-stat">
                            <span class="stat-value" id="profileActivities">0</span>
                            <span class="stat-label">نشاط</span>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="showEditProfileModal()" style="margin-top: 10px;">
                    <i class="fas fa-edit"></i> تعديل الملف
                </button>
            </div>
            
            <div class="profile-content">
                <div class="table-container" style="margin-bottom: 20px;">
                    <div class="table-header">
                        <h3>المعلومات الشخصية</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <tr>
                                <td style="min-width: 120px;"><strong>اسم المستخدم:</strong></td>
                                <td id="profileUsername">-</td>
                            </tr>
                            <tr>
                                <td><strong>الكلية:</strong></td>
                                <td id="profileFaculty">-</td>
                            </tr>
                            <tr>
                                <td><strong>المستوى الدراسي:</strong></td>
                                <td id="profileStudyLevel">-</td>
                            </tr>
                            <tr>
                                <td><strong>رقم القيد:</strong></td>
                                <td id="profileUniversityId">-</td>
                            </tr>
                            <tr>
                                <td><strong>رقم الهاتف:</strong></td>
                                <td id="profilePhone">-</td>
                            </tr>
                            <tr>
                                <td><strong>الدور:</strong></td>
                                <td id="profileRole">-</td>
                            </tr>
                            <tr>
                                <td><strong>تاريخ الانضمام:</strong></td>
                                <td id="profileJoinDate">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>آخر التقييمات</h3>
                    </div>
                    <div id="profileEvaluations">
                        <p style="text-align: center; padding: 20px; color: var(--dark-gray);">لا توجد تقييمات بعد</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة الإدارة -->
        <div id="adminPage" class="page-content" style="display: none;">
            <h1 style="margin-bottom: 10px; font-size: 1.5rem;">لوحة الإدارة</h1>
            <p style="margin-bottom: 20px; color: var(--dark-gray);">إدارة النظام والمستخدمين</p>
            
            <div class="admin-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="admin-card" style="background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <h3 style="color: var(--primary-green); margin-bottom: 10px; font-size: 1.1rem;"><i class="fas fa-user-cog"></i> إدارة المستخدمين</h3>
                    <p style="color: var(--dark-gray); font-size: 0.9rem; margin-bottom: 15px;">إنشاء حسابات جديدة وإدارة المستخدمين الحاليين</p>
                    <button class="btn" onclick="showCreateUserModal()">
                        <i class="fas fa-user-plus"></i> إنشاء حساب جديد
                    </button>
                </div>
                
                <div class="admin-card" style="background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <h3 style="color: var(--primary-green); margin-bottom: 10px; font-size: 1.1rem;"><i class="fas fa-key"></i> إدارة كلمات المرور</h3>
                    <p style="color: var(--dark-gray); font-size: 0.9rem; margin-bottom: 15px;">إعادة تعيين كلمات المرور للمستخدمين</p>
                    <button class="btn" onclick="showResetPasswordModal()">
                        <i class="fas fa-key"></i> إعادة تعيين كلمات المرور
                    </button>
                </div>
                
                <div class="admin-card" style="background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <h3 style="color: var(--primary-green); margin-bottom: 10px; font-size: 1.1rem;"><i class="fas fa-chart-pie"></i> الإحصائيات</h3>
                    <p style="color: var(--dark-gray); font-size: 0.9rem; margin-bottom: 15px;">عرض إحصائيات النظام والاستخدام</p>
                    <button class="btn" onclick="showSystemStatsModal()">
                        <i class="fas fa-chart-line"></i> عرض الإحصائيات
                    </button>
                </div>
                
                <div class="admin-card" style="background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);">
                    <h3 style="color: var(--primary-green); margin-bottom: 10px; font-size: 1.1rem;"><i class="fas fa-database"></i> إدارة البيانات</h3>
                    <p style="color: var(--dark-gray); font-size: 0.9rem; margin-bottom: 15px;">نسخ احتياطي واستعادة البيانات</p>
                    <button class="btn" onclick="showBackupModal()">
                        <i class="fas fa-save"></i> النسخ الاحتياطي
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3>سجل النظام</h3>
                </div>
                <div class="table-responsive">
                    <div id="systemLogs">
                        <p style="text-align: center; padding: 20px; color: var(--dark-gray);">جاري تحميل سجل النظام...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- قسم الفريق المطور -->
        <div class="dev-team" style="margin-top: 30px; padding: 20px; background: var(--lighter-green); border-radius: var(--border-radius); text-align: center;">
            <h2 style="color: var(--primary-green); margin-bottom: 10px;">الفريق المطور</h2>
            <p style="color: var(--dark-gray); margin-bottom: 15px;">تم تطوير هذا النظام بكل حب وإخلاص من أجل خدمة الطلبة الجزائريين الأحرار</p>
            <div class="dev-names" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                <span class="dev-name" style="background: var(--gradient-gold); color: var(--dark-green); padding: 8px 15px; border-radius: 20px; font-weight: 700;">Redox Ameri</span>
                <span class="dev-name" style="background: var(--gradient-gold); color: var(--dark-green); padding: 8px 15px; border-radius: 20px; font-weight: 700;">Riyad Youcef</span>
            </div>
        </div>
    </div>

    <!-- شريط التنقل السفلي للهواتف -->
    <nav class="bottom-nav" id="bottomNav">
        <ul class="bottom-nav-items">
            <li class="bottom-nav-item">
                <a href="#" onclick="showPage('dashboard')" class="bottom-nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>الرئيسية</span>
                </a>
            </li>
            <li class="bottom-nav-item">
                <a href="#" onclick="showPage('messages')" class="bottom-nav-link">
                    <i class="fas fa-comments"></i>
                    <span>الرسائل</span>
                </a>
            </li>
            <li class="bottom-nav-item">
                <a href="#" onclick="showPage('background')" class="bottom-nav-link">
                    <i class="fas fa-image"></i>
                    <span>خلفية</span>
                </a>
            </li>
            <li class="bottom-nav-item">
                <a href="#" onclick="showPage('members')" class="bottom-nav-link">
                    <i class="fas fa-users"></i>
                    <span>الأعضاء</span>
                </a>
            </li>
            <li class="bottom-nav-item">
                <a href="#" onclick="showPage('profile')" class="bottom-nav-link">
                    <i class="fas fa-user"></i>
                    <span>الملف</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- النماذج (Modals) -->

    <!-- نموذج إنشاء مستخدم جديد (للمسؤول) -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> إنشاء حساب جديد</h3>
                <button class="modal-close" onclick="hideModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" id="newUsername" class="form-control" placeholder="أدخل اسم المستخدم">
                </div>
                <div class="form-group">
                    <label class="form-label">الاسم الكامل</label>
                    <input type="text" id="newFullName" class="form-control" placeholder="أدخل الاسم الكامل">
                </div>
                <div class="form-group">
                    <label class="form-label">البريد الإلكتروني</label>
                    <input type="email" id="newEmail" class="form-control" placeholder="أدخل البريد الإلكتروني">
                </div>
                <div class="form-group">
                    <label class="form-label">رقم القيد الجامعي</label>
                    <input type="text" id="newUniversityId" class="form-control" placeholder="أدخل رقم القيد الجامعي">
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="أدخل كلمة المرور">
                </div>
                <div class="form-group">
                    <label class="form-label">تأكيد كلمة المرور</label>
                    <input type="password" id="newConfirmPassword" class="form-control" placeholder="أكد كلمة المرور">
                </div>
                <div class="form-group">
                    <label class="form-label">الدور</label>
                    <select id="newRole" class="form-control">
                        <option value="member">عضو</option>
                        <option value="organization_head">رئيس تنظيم</option>
                        <option value="admin">مدير</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">النقاط الابتدائية</label>
                    <input type="number" id="newPoints" class="form-control" value="0" min="0">
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="createUserByAdmin()">
                    <i class="fas fa-save"></i> إنشاء الحساب
                </button>
            </div>
        </div>
    </div>
    
    <!-- نموذج إعادة تعيين كلمة المرور -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> إعادة تعيين كلمة المرور</h3>
                <button class="modal-close" onclick="hideModal('resetPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اختر المستخدم</label>
                    <select id="userForReset" class="form-control">
                        <option value="">اختر المستخدم</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور الجديدة</label>
                    <input type="password" id="resetPassword" class="form-control" placeholder="أدخل كلمة المرور الجديدة">
                </div>
                <div class="form-group">
                    <label class="form-label">تأكيد كلمة المرور الجديدة</label>
                    <input type="password" id="resetConfirmPassword" class="form-control" placeholder="أكد كلمة المرور الجديدة">
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="resetUserPassword()">
                    <i class="fas fa-sync-alt"></i> إعادة التعيين
                </button>
            </div>
        </div>
    </div>
    
    <!-- نموذج رسالة جديدة -->
    <div id="newMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-envelope"></i> رسالة جديدة</h3>
                <button class="modal-close" onclick="hideModal('newMessageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">إرسال إلى</label>
                    <select id="messageReceiver" class="form-control">
                        <option value="">اختر العضو</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">الرسالة</label>
                    <textarea id="messageContent" class="form-control" rows="4" placeholder="اكتب رسالتك هنا..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">إرفاق صورة (اختياري)</label>
                    <div class="file-upload">
                        <div class="file-upload-btn" id="messageImageUploadBtn">
                            <i class="fas fa-image"></i> اختر صورة للرسالة
                        </div>
                        <input type="file" id="messageImage" class="form-control" accept="image/*" onchange="previewMessageImage(this)">
                    </div>
                    <div class="image-preview" id="messageImagePreview">
                        <img id="messageImagePreviewImg" src="" alt="معاينة صورة الرسالة" style="max-width: 100%; max-height: 150px;">
                    </div>
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="sendNewMessage()">
                    <i class="fas fa-paper-plane"></i> إرسال الرسالة
                </button>
            </div>
        </div>
    </div>

    <!-- نموذج إحصائيات النظام -->
    <div id="systemStatsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-pie"></i> إحصائيات النظام</h3>
                <button class="modal-close" onclick="hideModal('systemStatsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="systemStatsContent">
                    <div class="form-group">
                        <div class="stat-card" style="margin-bottom: 15px;">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>إجمالي المستخدمين</h3>
                                <div class="stat-number" id="statsTotalUsers">0</div>
                                <div class="stat-text">مستخدم</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="stat-card" style="margin-bottom: 15px;">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-info">
                                <h3>إجمالي المهام</h3>
                                <div class="stat-number" id="statsTotalTasks">0</div>
                                <div class="stat-text">مهمة</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="stat-card" style="margin-bottom: 15px;">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-info">
                                <h3>إجمالي الأنشطة</h3>
                                <div class="stat-number" id="statsTotalActivities">0</div>
                                <div class="stat-text">نشاط</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="stat-card" style="margin-bottom: 15px;">
                            <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                                <i class="fas fa-images"></i>
                            </div>
                            <div class="stat-info">
                                <h3>الصور المخزنة</h3>
                                <div class="stat-number" id="statsTotalImages">0</div>
                                <div class="stat-text">صورة</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج النسخ الاحتياطي -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-database"></i> النسخ الاحتياطي للبيانات</h3>
                <button class="modal-close" onclick="hideModal('backupModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h4 style="color: var(--primary-green); margin-bottom: 15px;">إنشاء نسخة احتياطية</h4>
                    <p style="margin-bottom: 15px; color: var(--dark-gray); font-size: 0.9rem;">قم بإنشاء نسخة احتياطية من جميع بيانات النظام.</p>
                    <button class="btn btn-primary btn-block" onclick="createBackup()">
                        <i class="fas fa-save"></i> إنشاء نسخة احتياطية
                    </button>
                </div>
                
                <div class="form-group" style="border-top: 1px solid var(--medium-gray); padding-top: 20px; margin-top: 20px;">
                    <h4 style="color: var(--primary-green); margin-bottom: 15px;">استعادة البيانات</h4>
                    <p style="margin-bottom: 15px; color: var(--dark-gray); font-size: 0.9rem;">تحميل نسخة احتياطية سابقة لاستعادة البيانات.</p>
                    <div class="file-upload">
                        <div class="file-upload-btn" id="restoreUploadBtn">
                            <i class="fas fa-upload"></i> اختر ملف النسخة الاحتياطية
                        </div>
                        <input type="file" id="restoreFile" class="form-control" accept=".json">
                    </div>
                    <button class="btn btn-block" style="margin-top: 15px;" onclick="restoreFromBackup()" id="restoreBtn" disabled>
                        <i class="fas fa-undo"></i> استعادة البيانات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج تعديل الملف الشخصي -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> تعديل الملف الشخصي</h3>
                <button class="modal-close" onclick="hideModal('editProfileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">الاسم الكامل</label>
                    <input type="text" id="editFullName" class="form-control" placeholder="الاسم الكامل">
                </div>
                <div class="form-group">
                    <label class="form-label">رقم الهاتف</label>
                    <input type="text" id="editPhone" class="form-control" placeholder="رقم الهاتف">
                </div>
                <div class="form-group">
                    <label class="form-label">الكلية</label>
                    <input type="text" id="editFaculty" class="form-control" placeholder="الكلية">
                </div>
                <div class="form-group">
                    <label class="form-label">المستوى الدراسي</label>
                    <input type="text" id="editStudyLevel" class="form-control" placeholder="المستوى الدراسي">
                </div>
                <div class="form-group">
                    <label class="form-label">صورة الملف الشخصي</label>
                    <div class="file-upload">
                        <div class="file-upload-btn" id="editProfileImageBtn">
                            <i class="fas fa-camera"></i> اختر صورة جديدة
                        </div>
                        <input type="file" id="editProfileImage" class="form-control" accept="image/*" onchange="previewEditProfileImage(this)">
                    </div>
                    <div class="image-preview" id="editProfileImagePreview">
                        <img id="editProfileImagePreviewImg" src="" alt="معاينة الصورة" style="max-width: 100%; max-height: 150px;">
                    </div>
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="updateProfile()">
                    <i class="fas fa-save"></i> حفظ التعديلات
                </button>
            </div>
        </div>
    </div>

    <!-- نموذج إنشاء مهمة -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> مهمة جديدة</h3>
                <button class="modal-close" onclick="hideModal('createTaskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">عنوان المهمة</label>
                    <input type="text" id="taskTitle" class="form-control" placeholder="عنوان المهمة">
                </div>
                <div class="form-group">
                    <label class="form-label">وصف المهمة</label>
                    <textarea id="taskDescription" class="form-control" rows="3" placeholder="وصف المهمة"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">تعيين إلى</label>
                    <select id="taskAssignedTo" class="form-control">
                        <option value="">اختر المستخدم</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">الأولوية</label>
                    <select id="taskPriority" class="form-control">
                        <option value="low">منخفضة</option>
                        <option value="medium" selected>متوسطة</option>
                        <option value="high">عالية</option>
                        <option value="urgent">عاجلة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">تاريخ التسليم</label>
                    <input type="date" id="taskDeadline" class="form-control">
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="createTask()">
                    <i class="fas fa-save"></i> إنشاء المهمة
                </button>
            </div>
        </div>
    </div>

    <!-- نموذج إنشاء نشاط -->
    <div id="createActivityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-plus"></i> نشاط جديد</h3>
                <button class="modal-close" onclick="hideModal('createActivityModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">عنوان النشاط</label>
                    <input type="text" id="activityTitle" class="form-control" placeholder="عنوان النشاط">
                </div>
                <div class="form-group">
                    <label class="form-label">وصف النشاط</label>
                    <textarea id="activityDescription" class="form-control" rows="3" placeholder="وصف النشاط"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">نوع النشاط</label>
                    <select id="activityType" class="form-control">
                        <option value="meeting">اجتماع</option>
                        <option value="academic">أكاديمي</option>
                        <option value="cultural">ثقافي</option>
                        <option value="sport">رياضي</option>
                        <option value="social">اجتماعي</option>
                        <option value="training">تدريبي</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">الموقع</label>
                    <input type="text" id="activityLocation" class="form-control" placeholder="موقع النشاط">
                </div>
                <div class="form-group">
                    <label class="form-label">تاريخ البدء</label>
                    <input type="datetime-local" id="activityStartDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">تاريخ الانتهاء</label>
                    <input type="datetime-local" id="activityEndDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">الحد الأقصى للمشاركين</label>
                    <input type="number" id="activityMaxParticipants" class="form-control" placeholder="عدد المشاركين" min="1">
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 20px;" onclick="createActivity()">
                    <i class="fas fa-save"></i> إنشاء النشاط
                </button>
            </div>
        </div>
    </div>

    <!-- رسالة النجاح -->
    <div id="successMessage" class="success-message">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="success-content">
            <h4 style="margin-bottom: 5px;">تمت العملية بنجاح!</h4>
            <p id="successMessageText" style="font-size: 0.9rem;">تم تنفيذ العملية المطلوبة بنجاح.</p>
        </div>
    </div>

    <!-- Loader overlay -->
    <div id="loader" class="loader-overlay">
        <div class="loader-content">
            <div class="spinner"></div>
            <div class="loader-message">جاري التحميل...</div>
        </div>
    </div>

    <!-- تنبيهات -->
    <div id="alertsContainer" style="position: fixed; top: 80px; right: 15px; z-index: 2000; max-width: 300px; width: calc(100% - 30px);">
        <!-- سيتم إضافة التنبيهات هنا -->
    </div>

    <script>
        // تحديث الرابط الأساسي للخادم
        const API_BASE_URL = '/api';
        let currentUser = null;
        let authToken = null;
        let currentPage = 'dashboard';
        let currentChat = null;
        let chatMessages = [];
        let chatUsers = {};
        let isChatOpen = false;
        let chatRefreshInterval = null;
        let backgroundImageData = null;
        let messageImageData = null;
        let selectedFileForRestore = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.querySelector('.splash-screen').style.opacity = '0';
                document.querySelector('.splash-screen').style.visibility = 'hidden';
                checkAuth();
            }, 2000);
            
            setupEventListeners();
            setupDragAndDrop();
            setupResponsiveBehavior();
            loadBackgroundFromStorage();
            setupTouchEvents();
        });
        
        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('registerPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            
            document.getElementById('userInfo').addEventListener('click', toggleUserDropdown);
            
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
            
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.addEventListener('click', function(event) {
                const userDropdown = document.getElementById('userDropdown');
                const userInfo = document.getElementById('userInfo');
                
                if (!userInfo.contains(event.target) && userDropdown.classList.contains('show')) {
                    userDropdown.classList.remove('show');
                }
            });
            
            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                hideSidebar();
            });
            
            const restoreFileInput = document.getElementById('restoreFile');
            if (restoreFileInput) {
                restoreFileInput.addEventListener('change', function(e) {
                    selectedFileForRestore = e.target.files[0];
                    if (selectedFileForRestore) {
                        document.getElementById('restoreBtn').disabled = false;
                        document.getElementById('restoreUploadBtn').innerHTML = 
                            `<i class="fas fa-check"></i> ${selectedFileForRestore.name}`;
                    }
                });
            }
            
            const backgroundOpacity = document.getElementById('backgroundOpacity');
            if (backgroundOpacity) {
                backgroundOpacity.addEventListener('input', function(e) {
                    const value = Math.round(e.target.value * 100);
                    document.getElementById('opacityValue').textContent = `${value}%`;
                });
            }
            
            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('dragstart', (e) => e.preventDefault());
            });
            
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, { passive: false });
        }
        
        function setupTouchEvents() {
            let lastTouchEnd = 0;
            
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            document.querySelectorAll('.chat-messages-wrapper, .table-responsive, .modal-body').forEach(element => {
                element.addEventListener('touchmove', function(e) {
                    if (this.scrollHeight > this.clientHeight) {
                        e.stopPropagation();
                    }
                });
            });
        }
        
        function setupDragAndDrop() {
            const dropAreas = [
                document.getElementById('backgroundUploadBtn'),
                document.getElementById('messageImageUploadBtn'),
                document.getElementById('editProfileImageBtn')
            ];
            
            dropAreas.forEach(dropArea => {
                if (!dropArea) return;
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.style.background = 'var(--lighter-green)';
                    dropArea.style.borderColor = 'var(--gold)';
                }
                
                function unhighlight() {
                    dropArea.style.background = '';
                    dropArea.style.borderColor = '';
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (dropArea.id === 'backgroundUploadBtn') {
                        document.getElementById('backgroundImage').files = files;
                        previewBackgroundImage({ files: files });
                    } else if (dropArea.id === 'messageImageUploadBtn') {
                        document.getElementById('messageImage').files = files;
                        previewMessageImage({ files: files });
                    } else if (dropArea.id === 'editProfileImageBtn') {
                        document.getElementById('editProfileImage').files = files;
                        previewEditProfileImage({ files: files });
                    }
                }
            });
        }
        
        function setupResponsiveBehavior() {
            function updateBottomNav() {
                const bottomNav = document.getElementById('bottomNav');
                if (window.innerWidth <= 768) {
                    bottomNav.classList.add('active');
                    document.getElementById('mainContent').classList.remove('no-bottom-nav');
                } else {
                    bottomNav.classList.remove('active');
                    document.getElementById('mainContent').classList.add('no-bottom-nav');
                }
            }
            
            updateBottomNav();
            window.addEventListener('resize', updateBottomNav);
            
            window.addEventListener('orientationchange', function() {
                setTimeout(updatePageLayout, 300);
            });
        }
        
        function updatePageLayout() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        }
        
        function loadBackgroundFromStorage() {
            const savedBackground = localStorage.getItem('userBackground');
            if (savedBackground) {
                try {
                    const bgData = JSON.parse(savedBackground);
                    applyBackground(bgData);
                } catch (e) {
                    console.error('Error loading background:', e);
                }
            }
        }
        
        function applyBackground(bgData) {
            const mainContent = document.getElementById('mainContent');
            if (mainContent && bgData.imageData) {
                mainContent.style.backgroundImage = `url(data:${bgData.mimeType};base64,${bgData.imageData})`;
                mainContent.style.backgroundSize = bgData.style || 'cover';
                mainContent.style.backgroundAttachment = 'scroll';
                mainContent.style.opacity = bgData.opacity || '0.9';
                mainContent.style.backgroundRepeat = bgData.repeat ? 'repeat' : 'no-repeat';
            }
        }
        
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                try {
                    authToken = token;
                    currentUser = JSON.parse(user);
                    showMainApp();
                    loadDashboardData();
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    showAuthPage();
                }
            } else {
                showAuthPage();
            }
        }
        
        function showAuthPage() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('navWrapper').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.getElementById('bottomNav').classList.remove('active');
        }
        
        function showRegisterForm(e) {
            if (e) e.preventDefault();
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }
        
        function showLoginForm(e) {
            if (e) e.preventDefault();
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }
        
        function showMainApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('navWrapper').style.display = 'block';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('bottomNav').classList.add('active');
            
            updateUserUI();
            
            showPage('dashboard');
            
            updatePageLayout();
        }
        
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
                document.getElementById('userRole').textContent = getRoleName(currentUser.role);
                document.getElementById('userPoints').textContent = `${currentUser.points || 0} نقاط`;
                
                const avatarElement = document.getElementById('userAvatar');
                if (currentUser.profileImage && avatarElement) {
                    avatarElement.innerHTML = '';
                    avatarElement.style.backgroundImage = `url(${currentUser.profileImage})`;
                    avatarElement.style.backgroundSize = 'cover';
                    avatarElement.style.backgroundPosition = 'center';
                }
                
                if (currentUser.role === 'admin' || currentUser.role === 'organization_head') {
                    document.getElementById('adminLink').style.display = 'block';
                    document.getElementById('adminMenuItem').style.display = 'block';
                }
            }
        }
        
        function getRoleName(role) {
            const roles = {
                'admin': 'مدير النظام',
                'organization_head': 'رئيس التنظيم',
                'member': 'عضو',
                'guest': 'زائر'
            };
            return roles[role] || role;
        }
        
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAlert('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تسجيل الدخول...';
            loginBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    currentUser = data.user;
                    authToken = data.token;
                    
                    showMainApp();
                    showSuccessMessage('تم تسجيل الدخول بنجاح', 'مرحباً بك في نظام إدارة التكتل');
                } else {
                    showAlert(data.message, 'error');
                }
                
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                
            } catch (error) {
                console.error('Login error:', error);
                showAlert('حدث خطأ في الاتصال بالسيرفر', 'error');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }
        
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const fullName = document.getElementById('registerFullName').value;
            const email = document.getElementById('registerEmail').value;
            const universityId = document.getElementById('registerUniversityId').value;
            
            if (!username || !password || !fullName || !email || !universityId) {
                showAlert('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('كلمتا المرور غير متطابقتين', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            const registerBtn = document.getElementById('registerBtn');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري إنشاء الحساب...';
            registerBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        fullName,
                        email,
                        universityId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    currentUser = data.user;
                    authToken = data.token;
                    
                    showMainApp();
                    showSuccessMessage('تم إنشاء الحساب بنجاح', 'مرحباً بك في نظام إدارة التكتل');
                } else {
                    showAlert(data.message, 'error');
                }
                
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
                
            } catch (error) {
                console.error('Registration error:', error);
                showAlert('حدث خطأ في الاتصال بالسيرفر', 'error');
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            currentUser = null;
            authToken = null;
            showAuthPage();
            showAlert('تم تسجيل الخروج بنجاح', 'success');
        }
        
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('show');
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        function hideSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showPage(pageName) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.bottom-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            if (window.innerWidth <= 768) {
                hideSidebar();
            }
            
            document.getElementById(`${pageName}Page`).style.display = 'block';
            
            const sidebarLink = document.querySelector(`.sidebar-menu a[onclick*="${pageName}"]`);
            const bottomNavLink = document.querySelector(`.bottom-nav-link[onclick*="${pageName}"]`);
            
            if (sidebarLink) sidebarLink.classList.add('active');
            if (bottomNavLink) bottomNavLink.classList.add('active');
            
            currentPage = pageName;
            
            switch (pageName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'activities':
                    loadActivities();
                    break;
                case 'background':
                    loadBackgroundSettings();
                    break;
                case 'members':
                    loadMembers();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'admin':
                    loadAdminData();
                    break;
            }
        }
        
        async function loadDashboardData() {
            try {
                showLoader();
                
                const response = await fetch(`${API_BASE_URL}/dashboard/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جدد إحصائيات لوحة التحكم');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // تحديث الإحصائيات
                    document.getElementById('totalMembers').textContent = data.stats.totalUsers;
                    document.getElementById('activeTasks').textContent = data.stats.pendingTasks;
                    document.getElementById('upcomingActivities').textContent = data.stats.upcomingActivities;
                    
                    // تحديث الشارات
                    document.getElementById('tasksBadge').textContent = data.stats.myTasks;
                    document.getElementById('activitiesBadge').textContent = data.stats.myActivities;
                    
                    // تحديث المتصدرين
                    displayLeaderboard(data.leaderboard);
                    
                    // تحديث الأنشطة الأخيرة
                    displayRecentActivities(data.recentActivities);
                    
                    // جدد الرسائل غير المقروءة
                    loadUnreadMessagesCount();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('فشل في تحميل بيانات لوحة التحكم', 'error');
                hideLoader();
            }
        }
        
        async function loadUnreadMessagesCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/messages/unread`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('unreadMessages').textContent = data.unreadCount;
                        document.getElementById('unreadBadge').textContent = data.unreadCount;
                    }
                }
            } catch (error) {
                console.error('Error loading unread messages:', error);
            }
        }
        
        function displayLeaderboard(leaderboard) {
            const container = document.getElementById('recentTasksTable');
            
            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد بيانات متاحة</p>';
                return;
            }
            
            let html = '<table>';
            html += `
                <tr>
                    <th>المركز</th>
                    <th>العضو</th>
                    <th>النقاط</th>
                    <th>الدور</th>
                </tr>
            `;
            
            leaderboard.forEach((user, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${user.profileImage ? 
                                    `<img src="${user.profileImage}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;">` :
                                    `<div class="default-avatar" style="width: 35px; height: 35px;">${getUserInitials(user.fullName)}</div>`
                                }
                                <div>
                                    <strong>${user.fullName}</strong><br>
                                    <small style="color: var(--dark-gray);">${user.faculty || ''}</small>
                                </div>
                            </div>
                        </td>
                        <td><strong>${user.points}</strong></td>
                        <td>${getRoleName(user.role)}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        function displayRecentActivities(activities) {
            const container = document.getElementById('upcomingActivitiesTable');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد أنشطة قادمة</p>';
                return;
            }
            
            let html = '<table>';
            html += `
                <tr>
                    <th>النشاط</th>
                    <th>المنظم</th>
                    <th>التاريخ</th>
                    <th>النوع</th>
                </tr>
            `;
            
            activities.forEach(activity => {
                const startDate = new Date(activity.startDate);
                const formattedDate = startDate.toLocaleDateString('ar-EG', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                html += `
                    <tr>
                        <td><strong>${activity.title}</strong></td>
                        <td>${activity.organizer.fullName}</td>
                        <td>${formattedDate}</td>
                        <td>${getActivityTypeName(activity.type)}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        function getActivityTypeName(type) {
            const types = {
                'academic': 'أكاديمي',
                'cultural': 'ثقافي',
                'sport': 'رياضي',
                'social': 'اجتماعي',
                'training': 'تدريبي',
                'meeting': 'اجتماع'
            };
            return types[type] || type;
        }
        
        function previewBackgroundImage(input) {
            const preview = document.getElementById('backgroundImagePreview');
            const previewDiv = document.getElementById('backgroundPreview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    backgroundImageData = {
                        data: base64Data,
                        mimeType: file.type,
                        size: file.size
                    };
                    
                    previewDiv.style.backgroundImage = `url(data:${file.type};base64,${base64Data})`;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function previewMessageImage(input) {
            const preview = document.getElementById('messageImagePreview');
            const previewImg = document.getElementById('messageImagePreviewImg');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    messageImageData = {
                        data: base64Data,
                        mimeType: file.type,
                        size: file.size
                    };
                    
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function previewEditProfileImage(input) {
            const preview = document.getElementById('editProfileImagePreview');
            const previewImg = document.getElementById('editProfileImagePreviewImg');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        async function saveBackgroundSettings() {
            if (!backgroundImageData) {
                showAlert('يرجى اختيار صورة خلفية أولاً', 'error');
                return;
            }
            
            try {
                showLoader('جاري حفظ الخلفية...');
                
                const style = document.getElementById('backgroundStyle').value;
                const opacity = document.getElementById('backgroundOpacity').value;
                
                const response = await fetch(`${API_BASE_URL}/users/upload-profile-image-base64`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageData: backgroundImageData.data,
                        mimeType: backgroundImageData.mimeType,
                        imageType: 'background'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في حفظ الخلفية');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // حفظ إعدادات الخلفية محلياً
                    const bgData = {
                        imageData: backgroundImageData.data,
                        mimeType: backgroundImageData.mimeType,
                        style: style,
                        opacity: opacity,
                        savedAt: new Date().toISOString()
                    };
                    
                    localStorage.setItem('userBackground', JSON.stringify(bgData));
                    applyBackground(bgData);
                    
                    showSuccessMessage('تم حفظ الخلفية', 'تم حفظ إعدادات الخلفية بنجاح');
                    
                    // تحديث قائمة الخلفيات المحفوظة
                    loadBackgroundSettings();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error saving background:', error);
                showAlert('فشل حفظ إعدادات الخلفية', 'error');
                hideLoader();
            }
        }
        
        async function loadBackgroundSettings() {
            try {
                const savedBackgrounds = JSON.parse(localStorage.getItem('savedBackgrounds') || '[]');
                const container = document.getElementById('savedBackgrounds');
                
                if (savedBackgrounds.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--dark-gray);">لا توجد خلفيات محفوظة</p>';
                    return;
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; padding: 15px;">';
                
                savedBackgrounds.forEach((bg, index) => {
                    html += `
                        <div style="cursor: pointer; border-radius: 10px; overflow: hidden; border: 2px solid var(--medium-gray); transition: var(--transition);"
                             onclick="applySavedBackground(${index})" 
                             onmouseover="this.style.transform='scale(1.05)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="height: 80px; background-image: url(data:${bg.mimeType};base64,${bg.imageData}); 
                                 background-size: cover; background-position: center;">
                            </div>
                            <div style="padding: 8px; background: var(--light-gray); text-align: center; font-size: 0.75rem;">
                                <i class="fas fa-calendar-alt"></i> ${formatDate(bg.savedAt)}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading background settings:', error);
            }
        }
        
        function applySavedBackground(index) {
            const savedBackgrounds = JSON.parse(localStorage.getItem('savedBackgrounds') || '[]');
            if (savedBackgrounds[index]) {
                applyBackground(savedBackgrounds[index]);
                showSuccessMessage('تم تطبيق الخلفية', 'تم تطبيق الخلفية المحددة بنجاح');
            }
        }
        
        function resetBackground() {
            if (confirm('هل تريد إعادة تعيين الخلفية إلى الوضع الافتراضي؟')) {
                localStorage.removeItem('userBackground');
                const mainContent = document.getElementById('mainContent');
                mainContent.style.backgroundImage = '';
                mainContent.style.backgroundColor = '';
                mainContent.style.opacity = '1';
                showSuccessMessage('تمت إعادة التعيين', 'تمت إعادة تعيين الخلفية بنجاح');
            }
        }
        
        async function loadMessages() {
            try {
                showLoader('جاري تحميل المحادثات...');
                
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب المحادثات');
                }
                
                const data = await response.json();
                
                if (data.success && data.messages && data.messages.length > 0) {
                    displayConversations(data.messages);
                } else {
                    displayNoConversations();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading messages:', error);
                showAlert('فشل في تحميل المحادثات', 'error');
                displayNoConversations();
                hideLoader();
            }
        }
        
        function displayConversations(messages) {
            const container = document.getElementById('chatList');
            
            if (messages.length === 0) {
                displayNoConversations();
                return;
            }
            
            const conversations = {};
            
            messages.forEach(message => {
                const otherUser = message.sender._id === currentUser.id ? message.receiver : message.sender;
                const otherUserId = otherUser._id;
                
                if (!conversations[otherUserId]) {
                    conversations[otherUserId] = {
                        user: otherUser,
                        lastMessage: message,
                        unreadCount: message.receiver._id === currentUser.id && !message.isRead ? 1 : 0,
                        messages: [message]
                    };
                } else {
                    conversations[otherUserId].messages.push(message);
                    if (new Date(message.createdAt) > new Date(conversations[otherUserId].lastMessage.createdAt)) {
                        conversations[otherUserId].lastMessage = message;
                    }
                    if (message.receiver._id === currentUser.id && !message.isRead) {
                        conversations[otherUserId].unreadCount++;
                    }
                }
            });
            
            const conversationList = Object.values(conversations).sort((a, b) => {
                return new Date(b.lastMessage.createdAt) - new Date(a.lastMessage.createdAt);
            });
            
            if (conversationList.length === 0) {
                displayNoConversations();
                return;
            }
            
            let html = '';
            
            conversationList.forEach(conv => {
                const lastMessage = conv.lastMessage;
                const isSentByMe = lastMessage.sender._id === currentUser.id;
                const messageContent = lastMessage.content || '[صورة]';
                const messageTime = formatMessageTime(lastMessage.createdAt);
                
                html += `
                    <div class="chat-list-item" onclick="openChat('${conv.user._id}')" 
                         data-user-id="${conv.user._id}">
                        <div class="chat-list-item-avatar" style="background: ${getRandomGradient(conv.user._id)};">
                            ${getUserInitials(conv.user.fullName || conv.user.username)}
                        </div>
                        <div class="chat-list-item-info">
                            <div class="chat-list-item-name">
                                ${conv.user.fullName || conv.user.username}
                                ${conv.user.role === 'admin' ? ' 👑' : ''}
                            </div>
                            <div class="chat-list-item-last-message">
                                ${isSentByMe ? 'أنت: ' : ''}${messageContent}
                            </div>
                        </div>
                        <div class="chat-list-item-meta">
                            <div class="chat-list-item-time">${messageTime}</div>
                            ${conv.unreadCount > 0 ? `
                                <div class="chat-list-item-unread">${conv.unreadCount}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            setupChatSearch();
        }
        
        function displayNoConversations() {
            const container = document.getElementById('chatList');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <i class="fas fa-comments" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--dark-gray); font-size: 1.1rem;">لا توجد محادثات</h3>
                    <p style="color: var(--dark-gray); font-size: 0.9rem;">ابدأ محادثة جديدة للتواصل مع الأعضاء</p>
                    <button class="btn" onclick="showNewMessageModal()" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> بدء محادثة
                    </button>
                </div>
            `;
        }
        
        async function openChat(userId) {
            try {
                showLoader();
                
                document.getElementById('messagesPage').querySelector('.chat-list-container').style.display = 'none';
                document.getElementById('chatInterface').classList.add('active');
                
                const userResponse = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error('فشل في جلب معلومات المستخدم');
                }
                
                const userData = await userResponse.json();
                
                if (!userData.success) {
                    throw new Error(userData.message);
                }
                
                currentChat = userData.user;
                
                updateChatInterface(currentChat);
                
                const messagesResponse = await fetch(`${API_BASE_URL}/messages/conversation/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error('فشل في جلب الرسائل');
                }
                
                const messagesData = await messagesResponse.json();
                
                if (messagesData.success) {
                    chatMessages = messagesData.messages || [];
                    displayMessages(chatMessages);
                }
                
                startChatRefresh();
                
                document.getElementById('bottomNav').classList.remove('active');
                
                hideLoader();
                
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendMessageBtn').disabled = false;
                
            } catch (error) {
                console.error('Error opening chat:', error);
                showAlert('فشل في فتح المحادثة', 'error');
                closeChat();
                hideLoader();
            }
        }
        
        function updateChatInterface(user) {
            document.getElementById('currentChatName').textContent = user.fullName || user.username;
            document.getElementById('currentChatStatus').textContent = 'متصل الآن';
            
            const avatar = document.getElementById('currentChatAvatar');
            if (user.profileImage) {
                avatar.innerHTML = '';
                avatar.style.backgroundImage = `url(${user.profileImage})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
            } else {
                avatar.innerHTML = getUserInitials(user.fullName || user.username);
                avatar.style.background = getRandomGradient(user._id);
                avatar.style.backgroundImage = '';
            }
        }
        
        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-comments" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark-gray); font-size: 1.1rem;">لا توجد رسائل</h3>
                        <p style="color: var(--dark-gray); font-size: 0.9rem;">ابدأ المحادثة بإرسال رسالة</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let lastDate = null;
            
            messages.forEach((message, index) => {
                const isSentByMe = message.sender._id === currentUser.id;
                const messageDate = new Date(message.createdAt);
                const currentDate = formatMessageDate(messageDate);
                
                if (currentDate !== lastDate) {
                    html += `
                        <div style="text-align: center; margin: 15px 0;">
                            <span style="background: var(--light-gray); color: var(--dark-gray); 
                                  padding: 5px 15px; border-radius: 15px; font-size: 0.8rem;">
                                ${currentDate}
                            </span>
                        </div>
                    `;
                    lastDate = currentDate;
                }
                
                html += `
                    <div class="message ${isSentByMe ? 'message-sent' : 'message-received'}" 
                         data-message-id="${message._id}">
                        ${message.content || ''}
                        ${message.attachments && message.attachments.length > 0 ? 
                            message.attachments.map(img => `
                                <img src="${img}" class="message-image" 
                                     onclick="expandImage('${img}')">
                            `).join('') : ''
                        }
                        <div class="message-time">${formatMessageTime(message.createdAt)}</div>
                        ${isSentByMe ? `
                            <div class="message-status">
                                ${message.isRead ? '✓✓' : '✓'}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChat) {
                showAlert('يرجى كتابة رسالة', 'warning');
                return;
            }
            
            try {
                const sendBtn = document.getElementById('sendMessageBtn');
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receiverId: currentChat._id,
                        content: content
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إرسال الرسالة');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const newMessage = data.data;
                    chatMessages.push(newMessage);
                    displayMessages(chatMessages);
                    
                    input.value = '';
                    
                    showSuccessMessage('تم إرسال الرسالة', 'تم إرسال رسالتك بنجاح');
                }
                
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('فشل في إرسال الرسالة', 'error');
                
                document.getElementById('sendMessageBtn').disabled = false;
                document.getElementById('sendMessageBtn').innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }
        
        async function attachImageToMessage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            
            input.onchange = async function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    if (file.size > 5 * 1024 * 1024) {
                        showAlert('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const base64Data = e.target.result.split(',')[1];
                            const mimeType = file.type;
                            
                            showLoader('جاري رفع الصورة...');
                            
                            const response = await fetch(`${API_BASE_URL}/messages/upload-image`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${authToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    imageData: base64Data,
                                    mimeType: mimeType
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error('فشل في رفع الصورة');
                            }
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                await sendMessageWithImage(data.imageId);
                            }
                            
                            hideLoader();
                            
                        } catch (error) {
                            console.error('Error uploading image:', error);
                            showAlert('فشل في رفع الصورة', 'error');
                            hideLoader();
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }
        
        async function sendMessageWithImage(imageId) {
            try {
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receiverId: currentChat._id,
                        content: '',
                        attachments: [imageId]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إرسال الرسالة');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    chatMessages.push(data.data);
                    displayMessages(chatMessages);
                    showSuccessMessage('تم إرسال الصورة', 'تم إرسال صورتك بنجاح');
                }
                
            } catch (error) {
                console.error('Error sending message with image:', error);
                showAlert('فشل في إرسال الصورة', 'error');
            }
        }
        
        function closeChat() {
            stopChatRefresh();
            
            document.getElementById('chatInterface').classList.remove('active');
            
            document.getElementById('messagesPage').querySelector('.chat-list-container').style.display = 'flex';
            
            if (window.innerWidth <= 768) {
                document.getElementById('bottomNav').classList.add('active');
            }
            
            currentChat = null;
            chatMessages = [];
            
            loadMessages();
        }
        
        function startChatRefresh() {
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
            }
            
            chatRefreshInterval = setInterval(async () => {
                if (currentChat) {
                    await refreshChatMessages();
                }
            }, 5000);
        }
        
        function stopChatRefresh() {
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
                chatRefreshInterval = null;
            }
        }
        
        async function refreshChatMessages() {
            try {
                const response = await fetch(`${API_BASE_URL}/messages/conversation/${currentChat._id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.messages.length !== chatMessages.length) {
                        chatMessages = data.messages;
                        displayMessages(chatMessages);
                    }
                }
            } catch (error) {
                console.error('Error refreshing messages:', error);
            }
        }
        
        async function loadMembers() {
            try {
                showLoader('جاري تحميل الأعضاء...');
                
                const searchTerm = document.getElementById('memberSearch').value;
                let url = `${API_BASE_URL}/users`;
                
                if (searchTerm) {
                    url = `${API_BASE_URL}/admin/users/search?search=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب الأعضاء');
                }
                
                const data = await response.json();
                
                const container = document.getElementById('membersTable');
                
                if (!data.users || data.users.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--dark-gray);">لا يوجد أعضاء</p>';
                    return;
                }
                
                let html = '<table>';
                html += `
                    <tr>
                        <th>الاسم</th>
                        <th>البريد</th>
                        <th>الدور</th>
                        <th>النقاط</th>
                        <th>الحالة</th>
                        ${currentUser.role === 'admin' ? '<th>الإجراءات</th>' : ''}
                    </tr>
                `;
                
                data.users.forEach(user => {
                    html += `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${user.profileImage ? 
                                        `<img src="${user.profileImage}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;">` :
                                        `<div class="default-avatar" style="width: 35px; height: 35px;">${getUserInitials(user.fullName)}</div>`
                                    }
                                    <div>
                                        <strong>${user.fullName}</strong><br>
                                        <small style="color: var(--dark-gray);">@${user.username}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${user.email}</td>
                            <td>${getRoleName(user.role)}</td>
                            <td><strong>${user.points || 0}</strong></td>
                            <td>
                                <span style="padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; background: ${user.isActive ? '#d4edda' : '#f8d7da'}; color: ${user.isActive ? '#155724' : '#721c24'}">
                                    ${user.isActive ? 'نشط' : 'معطل'}
                                </span>
                            </td>
                            ${currentUser.role === 'admin' ? `
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn btn-sm" onclick="toggleUserStatus('${user._id}', ${!user.isActive})" title="${user.isActive ? 'تعطيل' : 'تفعيل'}">
                                            <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i>
                                        </button>
                                        <button class="btn btn-sm" onclick="showEditUserModal('${user._id}')" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm" onclick="deleteUser('${user._id}')" title="حذف">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            ` : ''}
                        </tr>
                    `;
                });
                
                html += '</table>';
                container.innerHTML = html;
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading members:', error);
                showAlert('فشل في تحميل الأعضاء', 'error');
                hideLoader();
            }
        }
        
        async function loadProfile() {
            try {
                showLoader('جاري تحميل الملف الشخصي...');
                
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب بيانات الملف الشخصي');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    
                    document.getElementById('profileName').textContent = user.fullName || user.username;
                    document.getElementById('profileEmail').textContent = user.email;
                    document.getElementById('profilePoints').textContent = user.points || 0;
                    
                    const profileAvatar = document.getElementById('profileAvatar');
                    if (user.profileImage) {
                        profileAvatar.innerHTML = '';
                        profileAvatar.style.backgroundImage = `url(${user.profileImage})`;
                        profileAvatar.style.backgroundSize = 'cover';
                        profileAvatar.style.backgroundPosition = 'center';
                    } else {
                        profileAvatar.innerHTML = '<i class="fas fa-user" style="font-size: 2.5rem;"></i>';
                        profileAvatar.style.backgroundImage = '';
                    }
                    
                    document.getElementById('profileUsername').textContent = user.username;
                    document.getElementById('profileFaculty').textContent = user.faculty || 'غير محدد';
                    document.getElementById('profileStudyLevel').textContent = user.studyLevel || 'غير محدد';
                    document.getElementById('profileUniversityId').textContent = user.universityId || 'غير محدد';
                    document.getElementById('profilePhone').textContent = user.phone || 'غير محدد';
                    document.getElementById('profileRole').textContent = getRoleName(user.role);
                    document.getElementById('profileJoinDate').textContent = formatDate(user.joinDate);
                    
                    // تحميل مهام المستخدم
                    const tasksResponse = await fetch(`${API_BASE_URL}/tasks/my-tasks`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (tasksResponse.ok) {
                        const tasksData = await tasksResponse.json();
                        if (tasksData.success) {
                            document.getElementById('profileTasks').textContent = tasksData.tasks.length;
                        }
                    }
                    
                    // تحميل أنشطة المستخدم
                    const activitiesResponse = await fetch(`${API_BASE_URL}/activities`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (activitiesResponse.ok) {
                        const activitiesData = await activitiesResponse.json();
                        if (activitiesData.success) {
                            document.getElementById('profileActivities').textContent = activitiesData.activities.length;
                        }
                    }
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('فشل في تحميل الملف الشخصي', 'error');
                hideLoader();
            }
        }
        
        async function loadAdminData() {
            try {
                showLoader('جاري تحميل بيانات الإدارة...');
                
                const response = await fetch(`${API_BASE_URL}/admin/statistics`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جدد بيانات الإدارة');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // تحديث إحصائيات النظام
                    const stats = data.statistics;
                    document.getElementById('statsTotalUsers').textContent = stats.users.total;
                    document.getElementById('statsTotalTasks').textContent = stats.tasks.total;
                    document.getElementById('statsTotalActivities').textContent = stats.activities.total;
                    document.getElementById('statsTotalImages').textContent = stats.images.total;
                }
                
                // تحميل سجل النظام
                loadSystemLogs();
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showAlert('فشل في تحميل بيانات الإدارة', 'error');
                hideLoader();
            }
        }
        
        async function loadSystemLogs() {
            try {
                // في هذه النسخة المبسطة، سنعرض سجلاً وهمياً
                const logs = [
                    { date: new Date().toISOString(), action: 'تسجيل دخول', user: currentUser.fullName },
                    { date: new Date(Date.now() - 3600000).toISOString(), action: 'تحديث الملف الشخصي', user: 'مستخدم آخر' },
                    { date: new Date(Date.now() - 7200000).toISOString(), action: 'إنشاء مهمة جديدة', user: currentUser.fullName },
                    { date: new Date(Date.now() - 10800000).toISOString(), action: 'إرسال رسالة', user: 'مستخدم آخر' },
                    { date: new Date(Date.now() - 14400000).toISOString(), action: 'تسجيل مستخدم جديد', user: 'مدير النظام' }
                ];
                
                const container = document.getElementById('systemLogs');
                let html = '<table>';
                html += `
                    <tr>
                        <th>التاريخ والوقت</th>
                        <th>النشاط</th>
                        <th>المستخدم</th>
                    </tr>
                `;
                
                logs.forEach(log => {
                    const date = new Date(log.date);
                    const formattedDate = date.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>${log.action}</td>
                            <td>${log.user}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading system logs:', error);
            }
        }
        
        async function loadTasks() {
            try {
                showLoader('جاري تحميل المهام...');
                
                const response = await fetch(`${API_BASE_URL}/tasks/my-tasks`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب المهام');
                }
                
                const data = await response.json();
                
                const container = document.getElementById('tasksTable');
                
                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--dark-gray);">لا توجد مهام</p>';
                    return;
                }
                
                let html = '<table>';
                html += `
                    <tr>
                        <th>العنوان</th>
                        <th>المسند من</th>
                        <th>الأولوية</th>
                        <th>الحالة</th>
                        <th>تاريخ التسليم</th>
                        <th>الإجراءات</th>
                    </tr>
                `;
                
                data.tasks.forEach(task => {
                    const deadline = task.deadline ? new Date(task.deadline).toLocaleDateString('ar-EG') : 'غير محدد';
                    
                    html += `
                        <tr>
                            <td><strong>${task.title}</strong></td>
                            <td>${task.assignedBy.fullName}</td>
                            <td>
                                <span style="padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; 
                                      background: ${getPriorityColor(task.priority)}">
                                    ${getPriorityName(task.priority)}
                                </span>
                            </td>
                            <td>
                                <span style="padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; 
                                      background: ${getStatusColor(task.status)}; color: ${getStatusTextColor(task.status)}">
                                    ${getStatusName(task.status)}
                                </span>
                            </td>
                            <td>${deadline}</td>
                            <td>
                                <button class="btn btn-sm" onclick="updateTaskStatus('${task._id}', 'in_progress')" ${task.status !== 'pending' ? 'disabled' : ''}>
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-sm" onclick="updateTaskStatus('${task._id}', 'completed')" ${task.status !== 'in_progress' ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                container.innerHTML = html;
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                showAlert('فشل في تحميل المهام', 'error');
                hideLoader();
            }
        }
        
        function getPriorityColor(priority) {
            const colors = {
                'low': '#d4edda',
                'medium': '#fff3cd',
                'high': '#f8d7da',
                'urgent': '#dc3545'
            };
            return colors[priority] || '#e9ecef';
        }
        
        function getPriorityName(priority) {
            const names = {
                'low': 'منخفضة',
                'medium': 'متوسطة',
                'high': 'عالية',
                'urgent': 'عاجلة'
            };
            return names[priority] || priority;
        }
        
        function getStatusColor(status) {
            const colors = {
                'pending': '#fff3cd',
                'in_progress': '#cce5ff',
                'completed': '#d4edda',
                'cancelled': '#f8d7da'
            };
            return colors[status] || '#e9ecef';
        }
        
        function getStatusTextColor(status) {
            const colors = {
                'pending': '#856404',
                'in_progress': '#004085',
                'completed': '#155724',
                'cancelled': '#721c24'
            };
            return colors[status] || '#212529';
        }
        
        async function loadActivities() {
            try {
                showLoader('جاري تحميل الأنشطة...');
                
                const response = await fetch(`${API_BASE_URL}/activities/upcoming`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب الأنشطة');
                }
                
                const data = await response.json();
                
                const container = document.getElementById('activitiesTable');
                
                if (!data.activities || data.activities.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--dark-gray);">لا توجد أنشطة</p>';
                    return;
                }
                
                let html = '<table>';
                html += `
                    <tr>
                        <th>النشاط</th>
                        <th>النوع</th>
                        <th>الموقع</th>
                        <th>تاريخ البدء</th>
                        <th>المشاركين</th>
                        <th>الإجراءات</th>
                    </tr>
                `;
                
                data.activities.forEach(activity => {
                    const startDate = new Date(activity.startDate);
                    const formattedDate = startDate.toLocaleDateString('ar-EG', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <tr>
                            <td><strong>${activity.title}</strong></td>
                            <td>${getActivityTypeName(activity.type)}</td>
                            <td>${activity.location || 'غير محدد'}</td>
                            <td>${formattedDate}</td>
                            <td>${activity.participants ? activity.participants.length : 0}</td>
                            <td>
                                <button class="btn btn-sm" onclick="joinActivity('${activity._id}')" ${activity.participants && activity.participants.some(p => p._id === currentUser.id) ? 'disabled' : ''}>
                                    <i class="fas fa-user-plus"></i> انضم
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                container.innerHTML = html;
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading activities:', error);
                showAlert('فشل في تحميل الأنشطة', 'error');
                hideLoader();
            }
        }
        
        async function joinActivity(activityId) {
            try {
                showLoader('جاري الانضمام للنشاط...');
                
                const response = await fetch(`${API_BASE_URL}/activities/${activityId}/join`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في الانضمام للنشاط');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم الانضمام', 'تم الانضمام إلى النشاط بنجاح');
                    loadActivities();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error joining activity:', error);
                showAlert('فشل في الانضمام للنشاط', 'error');
                hideLoader();
            }
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-circle' : 
                                  type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <div style="flex: 1; font-size: 0.9rem;">
                    ${message}
                </div>
                <button onclick="document.getElementById('${alertId}').remove()" 
                        style="background: none; border: none; color: inherit; cursor: pointer; padding: 0 5px; font-size: 1.2rem;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            alertsContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (document.getElementById(alertId)) {
                    document.getElementById(alertId).remove();
                }
            }, 5000);
        }
        
        function showSuccessMessage(title, message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.querySelector('h4').textContent = title;
            document.getElementById('successMessageText').textContent = message;
            successMsg.classList.add('show');
            
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function formatMessageTime(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                const diffMinutes = Math.floor(diff / (1000 * 60));
                const diffHours = Math.floor(diff / (1000 * 60 * 60));
                const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (diffMinutes < 1) return 'الآن';
                if (diffMinutes < 60) return `${diffMinutes} دقيقة`;
                if (diffHours < 24) return `${diffHours} ساعة`;
                if (diffDays === 1) return 'أمس';
                if (diffDays < 7) return `${diffDays} يوم`;
                
                return date.toLocaleTimeString('ar-EG', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit'
                });
            } catch (e) {
                return '--:--';
            }
        }
        
        function formatMessageDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'اليوم';
                if (diffDays === 1) return 'أمس';
                if (diffDays < 7) return `${diffDays} يوم مضى`;
                
                return date.toLocaleDateString('ar-EG', {
                    day: '2-digit',
                    month: 'long'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function getUserInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function getRandomGradient(id) {
            const gradients = [
                'linear-gradient(135deg, #3498db, #2980b9)',
                'linear-gradient(135deg, #e74c3c, #c0392b)',
                'linear-gradient(135deg, #2ecc71, #27ae60)',
                'linear-gradient(135deg, #9b59b6, #8e44ad)',
                'linear-gradient(135deg, #f39c12, #d35400)',
                'linear-gradient(135deg, #1abc9c, #16a085)'
            ];
            const index = id ? id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % gradients.length : 0;
            return gradients[index];
        }
        
        function setupChatSearch() {
            const searchInput = document.getElementById('chatSearchInput');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const chatItems = document.querySelectorAll('.chat-list-item');
                
                chatItems.forEach(item => {
                    const userName = item.querySelector('.chat-list-item-name').textContent.toLowerCase();
                    const userMessage = item.querySelector('.chat-list-item-last-message').textContent.toLowerCase();
                    
                    if (userName.includes(searchTerm) || userMessage.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
        
        function expandImage(src) {
            const modal = document.createElement('div');
            modal.className = 'image-modal show';
            modal.innerHTML = `
                <img src="${src}" class="image-modal-content">
                <button class="modal-close" onclick="this.parentElement.remove()" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer;">&times;</button>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showChatInfo() {
            if (!currentChat) return;
            
            const infoHtml = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary-green);">معلومات المستخدم</h3>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div class="chat-list-item-avatar" style="width: 80px; height: 80px; font-size: 1.8rem;">
                            ${getUserInitials(currentChat.fullName || currentChat.username)}
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px;">${currentChat.fullName || currentChat.username}</h4>
                            <p style="color: var(--dark-gray); opacity: 0.8; margin-bottom: 3px;">${currentChat.email}</p>
                            <p style="color: var(--gold); font-weight: bold;">${getRoleName(currentChat.role)}</p>
                        </div>
                    </div>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: var(--border-radius-sm);">
                        <p style="margin-bottom: 10px;"><strong>الكلية:</strong> ${currentChat.faculty || 'غير محدد'}</p>
                        <p style="margin-bottom: 10px;"><strong>المستوى الدراسي:</strong> ${currentChat.studyLevel || 'غير محدد'}</p>
                        <p style="margin-bottom: 0;"><strong>تاريخ الانضمام:</strong> ${formatDate(currentChat.joinDate)}</p>
                    </div>
                </div>
            `;
            
            showAlert(infoHtml, 'info');
        }
        
        function showLoader(message = 'جاري التحميل...') {
            const loader = document.getElementById('loader');
            if (message) {
                loader.querySelector('.loader-message').textContent = message;
            }
            loader.classList.add('show');
        }
        
        function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.classList.remove('show');
            }
        }
        
        // وظائف إضافية للإدارة
        
        async function showCreateUserModal() {
            showModal('createUserModal');
        }
        
        async function createUserByAdmin() {
            try {
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('newConfirmPassword').value;
                const fullName = document.getElementById('newFullName').value;
                const email = document.getElementById('newEmail').value;
                const universityId = document.getElementById('newUniversityId').value;
                const role = document.getElementById('newRole').value;
                const points = parseInt(document.getElementById('newPoints').value) || 0;
                
                if (!username || !password || !fullName || !email || !universityId) {
                    showAlert('يرجى ملء جميع الحقول المطلوبة', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showAlert('كلمتا المرور غير متطابقتين', 'error');
                    return;
                }
                
                showLoader('جاري إنشاء الحساب...');
                
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        fullName,
                        email,
                        universityId,
                        role,
                        points
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إنشاء الحساب');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم إنشاء الحساب', 'تم إنشاء حساب المستخدم بنجاح');
                    hideModal('createUserModal');
                    loadMembers();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('فشل في إنشاء الحساب', 'error');
                hideLoader();
            }
        }
        
        async function showResetPasswordModal() {
            try {
                // جدد قائمة المستخدمين
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب المستخدمين');
                }
                
                const data = await response.json();
                
                const select = document.getElementById('userForReset');
                select.innerHTML = '<option value="">اختر المستخدم</option>';
                
                if (data.success && data.users) {
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = `${user.fullName} (${user.username})`;
                        select.appendChild(option);
                    });
                }
                
                showModal('resetPasswordModal');
                
            } catch (error) {
                console.error('Error loading users for reset:', error);
                showAlert('فشل في تحميل قائمة المستخدمين', 'error');
            }
        }
        
        async function resetUserPassword() {
            try {
                const userId = document.getElementById('userForReset').value;
                const newPassword = document.getElementById('resetPassword').value;
                const confirmPassword = document.getElementById('resetConfirmPassword').value;
                
                if (!userId) {
                    showAlert('يرجى اختيار مستخدم', 'error');
                    return;
                }
                
                if (!newPassword || !confirmPassword) {
                    showAlert('يرجى إدخال كلمة المرور الجديدة', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showAlert('كلمتا المرور غير متطابقتين', 'error');
                    return;
                }
                
                showLoader('جاري إعادة تعيين كلمة المرور...');
                
                const response = await fetch(`${API_BASE_URL}/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إعادة تعيين كلمة المرور');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم إعادة التعيين', 'تم إعادة تعيين كلمة المرور بنجاح');
                    hideModal('resetPasswordModal');
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error resetting password:', error);
                showAlert('فشل في إعادة تعيين كلمة المرور', 'error');
                hideLoader();
            }
        }
        
        async function showSystemStatsModal() {
            try {
                showLoader('جاري تحميل الإحصائيات...');
                
                const response = await fetch(`${API_BASE_URL}/admin/statistics`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جدد الإحصائيات');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('statsTotalUsers').textContent = stats.users.total;
                    document.getElementById('statsTotalTasks').textContent = stats.tasks.total;
                    document.getElementById('statsTotalActivities').textContent = stats.activities.total;
                    document.getElementById('statsTotalImages').textContent = stats.images.total;
                    
                    showModal('systemStatsModal');
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error loading system stats:', error);
                showAlert('فشل في تحميل الإحصائيات', 'error');
                hideLoader();
            }
        }
        
        function showBackupModal() {
            showModal('backupModal');
        }
        
        async function createBackup() {
            try {
                showLoader('جاري إنشاء النسخة الاحتياطية...');
                
                const response = await fetch(`${API_BASE_URL}/admin/backup`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إنشاء النسخة الاحتياطية');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // حفظ النسخة الاحتياطية محلياً
                    const backupData = data.backup;
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccessMessage('تم إنشاء النسخة', 'تم إنشاء النسخة الاحتياطية بنجاح');
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error creating backup:', error);
                showAlert('فشل في إنشاء النسخة الاحتياطية', 'error');
                hideLoader();
            }
        }
        
        async function restoreFromBackup() {
            if (!selectedFileForRestore) {
                showAlert('يرجى اختيار ملف النسخة الاحتياطية', 'error');
                return;
            }
            
            try {
                showLoader('جاري استعادة البيانات...');
                
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        const response = await fetch(`${API_BASE_URL}/admin/restore`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ backupData })
                        });
                        
                        if (!response.ok) {
                            throw new Error('فشل في استعادة البيانات');
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showSuccessMessage('تمت الاستعادة', 'تم استعادة البيانات بنجاح');
                            hideModal('backupModal');
                        }
                        
                        hideLoader();
                        
                    } catch (parseError) {
                        console.error('Error parsing backup file:', parseError);
                        showAlert('ملف النسخة الاحتياطية غير صالح', 'error');
                        hideLoader();
                    }
                };
                
                reader.readAsText(selectedFileForRestore);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                showAlert('فشل في استعادة البيانات', 'error');
                hideLoader();
            }
        }
        
        async function showEditProfileModal() {
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب بيانات المستخدم');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    document.getElementById('editFullName').value = user.fullName || '';
                    document.getElementById('editPhone').value = user.phone || '';
                    document.getElementById('editFaculty').value = user.faculty || '';
                    document.getElementById('editStudyLevel').value = user.studyLevel || '';
                    
                    showModal('editProfileModal');
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showAlert('فشل في تحميل بيانات المستخدم', 'error');
            }
        }
        
        async function updateProfile() {
            try {
                const fullName = document.getElementById('editFullName').value;
                const phone = document.getElementById('editPhone').value;
                const faculty = document.getElementById('editFaculty').value;
                const studyLevel = document.getElementById('editStudyLevel').value;
                
                showLoader('جاري تحديث الملف الشخصي...');
                
                const response = await fetch(`${API_BASE_URL}/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullName,
                        phone,
                        faculty,
                        studyLevel
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في تحديث الملف الشخصي');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // تحديث صورة الملف الشخصي إذا تم رفع صورة جديدة
                    const fileInput = document.getElementById('editProfileImage');
                    if (fileInput.files && fileInput.files[0]) {
                        await uploadProfileImage(fileInput.files[0]);
                    }
                    
                    showSuccessMessage('تم التحديث', 'تم تحديث الملف الشخصي بنجاح');
                    hideModal('editProfileModal');
                    loadProfile();
                    updateUserUI();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('فشل في تحديث الملف الشخصي', 'error');
                hideLoader();
            }
        }
        
        async function uploadProfileImage(file) {
            try {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = file.type;
                    
                    const response = await fetch(`${API_BASE_URL}/users/upload-profile-image-base64`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            imageData: base64Data,
                            mimeType: mimeType
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('فشل في رفع صورة الملف الشخصي');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        currentUser.profileImage = data.user.profileImage;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                    }
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error uploading profile image:', error);
            }
        }
        
        async function toggleUserStatus(userId, isActive) {
            if (!confirm(`هل تريد ${isActive ? 'تفعيل' : 'تعطيل'} هذا المستخدم؟`)) {
                return;
            }
            
            try {
                showLoader(`جاري ${isActive ? 'تفعيل' : 'تعطيل'} المستخدم...`);
                
                const response = await fetch(`${API_BASE_URL}/users/${userId}/toggle-status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في تغيير حالة المستخدم');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم التغيير', `تم ${isActive ? 'تفعيل' : 'تعطيل'} المستخدم بنجاح`);
                    loadMembers();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error toggling user status:', error);
                showAlert('فشل في تغيير حالة المستخدم', 'error');
                hideLoader();
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('هل تريد تأكيد حذف هذا المستخدم؟')) {
                return;
            }
            
            try {
                showLoader('جاري حذف المستخدم...');
                
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في حذف المستخدم');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم الحذف', 'تم حذف المستخدم بنجاح');
                    loadMembers();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('فشل في حذف المستخدم', 'error');
                hideLoader();
            }
        }
        
        function showNewMessageModal() {
            loadUsersForMessaging();
            showModal('newMessageModal');
        }
        
        async function loadUsersForMessaging() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب المستخدمين');
                }
                
                const data = await response.json();
                
                const select = document.getElementById('messageReceiver');
                select.innerHTML = '<option value="">اختر العضو</option>';
                
                if (data.success && data.users) {
                    data.users.forEach(user => {
                        if (user._id !== currentUser.id) {
                            const option = document.createElement('option');
                            option.value = user._id;
                            option.textContent = `${user.fullName} (${user.username})`;
                            select.appendChild(option);
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading users for messaging:', error);
                showAlert('فشل في تحميل قائمة المستخدمين', 'error');
            }
        }
        
        async function sendNewMessage() {
            const receiverId = document.getElementById('messageReceiver').value;
            const content = document.getElementById('messageContent').value;
            
            if (!receiverId) {
                showAlert('يرجى اختيار مستلم للرسالة', 'error');
                return;
            }
            
            if (!content.trim()) {
                showAlert('يرجى كتابة محتوى الرسالة', 'error');
                return;
            }
            
            try {
                showLoader('جاري إرسال الرسالة...');
                
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receiverId,
                        content
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إرسال الرسالة');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم الإرسال', 'تم إرسال الرسالة بنجاح');
                    hideModal('newMessageModal');
                    
                    // تحديث قائمة المحادثات
                    if (currentPage === 'messages') {
                        loadMessages();
                    }
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error sending new message:', error);
                showAlert('فشل في إرسال الرسالة', 'error');
                hideLoader();
            }
        }
        
        async function updateTaskStatus(taskId, status) {
            try {
                showLoader('جاري تحديث حالة المهمة...');
                
                const response = await fetch(`${API_BASE_URL}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في تحديث حالة المهمة');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم التحديث', 'تم تحديث حالة المهمة بنجاح');
                    loadTasks();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error updating task status:', error);
                showAlert('فشل في تحديث حالة المهمة', 'error');
                hideLoader();
            }
        }
        
        function showCreateTaskModal() {
            loadUsersForTaskAssignment();
            showModal('createTaskModal');
        }
        
        async function loadUsersForTaskAssignment() {
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب المستخدمين');
                }
                
                const data = await response.json();
                
                const select = document.getElementById('taskAssignedTo');
                select.innerHTML = '<option value="">اختر المستخدم</option>';
                
                if (data.success && data.users) {
                    data.users.forEach(user => {
                        if (user._id !== currentUser.id && user.role !== 'admin') {
                            const option = document.createElement('option');
                            option.value = user._id;
                            option.textContent = `${user.fullName} (${user.username})`;
                            select.appendChild(option);
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading users for task assignment:', error);
                showAlert('فشل في تحميل قائمة المستخدمين', 'error');
            }
        }
        
        async function createTask() {
            try {
                const title = document.getElementById('taskTitle').value;
                const description = document.getElementById('taskDescription').value;
                const assignedTo = document.getElementById('taskAssignedTo').value;
                const priority = document.getElementById('taskPriority').value;
                const deadline = document.getElementById('taskDeadline').value;
                
                if (!title || !assignedTo) {
                    showAlert('يرجى إدخال عنوان المهمة والمستخدم المسند إليه', 'error');
                    return;
                }
                
                showLoader('جاري إنشاء المهمة...');
                
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        assignedTo,
                        priority,
                        deadline: deadline ? new Date(deadline).toISOString() : null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إنشاء المهمة');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم الإنشاء', 'تم إنشاء المهمة بنجاح');
                    hideModal('createTaskModal');
                    loadTasks();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error creating task:', error);
                showAlert('فشل في إنشاء المهمة', 'error');
                hideLoader();
            }
        }
        
        function showCreateActivityModal() {
            showModal('createActivityModal');
        }
        
        async function createActivity() {
            try {
                const title = document.getElementById('activityTitle').value;
                const description = document.getElementById('activityDescription').value;
                const type = document.getElementById('activityType').value;
                const location = document.getElementById('activityLocation').value;
                const startDate = document.getElementById('activityStartDate').value;
                const endDate = document.getElementById('activityEndDate').value;
                const maxParticipants = document.getElementById('activityMaxParticipants').value;
                
                if (!title || !startDate || !endDate) {
                    showAlert('يرجى إدخال عنوان النشاط وتواريخ البدء والانتهاء', 'error');
                    return;
                }
                
                showLoader('جاري إنشاء النشاط...');
                
                const response = await fetch(`${API_BASE_URL}/activities`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        type,
                        location,
                        startDate: new Date(startDate).toISOString(),
                        endDate: new Date(endDate).toISOString(),
                        maxParticipants: maxParticipants ? parseInt(maxParticipants) : null
                    })
                });
                
                if (!response.ok) {
                    throw new Error('فشل في إنشاء النشاط');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('تم الإنشاء', 'تم إنشاء النشاط بنجاح');
                    hideModal('createActivityModal');
                    loadActivities();
                }
                
                hideLoader();
                
            } catch (error) {
                console.error('Error creating activity:', error);
                showAlert('فشل في إنشاء النشاط', 'error');
                hideLoader();
            }
        }
        
        // دالة مساعدة للحصول على اسم الحالة
        function getStatusName(status) {
            const statuses = {
                'pending': 'معلقة',
                'in_progress': 'قيد التنفيذ',
                'completed': 'مكتملة',
                'cancelled': 'ملغية'
            };
            return statuses[status] || status;
        }
    </script>
</body>
</html>